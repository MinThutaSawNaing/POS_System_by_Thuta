<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{ pos_name }} Dashboard</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css"
    />
    <style>
      :root {
        --sidebar-width: 250px;
        --sidebar-min-width: 220px;
        --sidebar-max-width: 420px;
        --sidebar-bg: #343a40;
        --sidebar-text: rgba(255, 255, 255, 0.75);
        --sidebar-active: white;
        --sidebar-hover: rgba(255, 255, 255, 0.1);
        --primary-color: #0d6efd;
      }

      body {
        overflow-x: hidden;
      }

      .sidebar {
        width: var(--sidebar-width);
        min-width: var(--sidebar-min-width);
        max-width: var(--sidebar-max-width);
        height: 100vh;
        background-color: var(--sidebar-bg);
        color: var(--sidebar-text);
        position: fixed;
        transition: all 0.3s;
        z-index: 1000;
        overflow-y: auto;
        overflow-x: hidden;
      }

      .sidebar-drag-handle {
        position: absolute;
        top: 0;
        right: 0;
        width: 10px;
        height: 100%;
        cursor: col-resize;
        background: transparent;
        z-index: 1002;
      }

      .sidebar-drag-handle:hover {
        background: rgba(255, 255, 255, 0.12);
      }

      .sidebar .nav-link {
        color: var(--sidebar-text);
        padding: 0.75rem 1rem;
        border-radius: 0.25rem;
        margin: 0.25rem 1rem;
        display: flex;
        align-items: center;
        width: calc(100% - 2rem);
      }

      .sidebar .nav-link:hover,
      .sidebar .nav-link.active {
        color: var(--sidebar-active);
        background-color: var(--sidebar-hover);
      }

      .sidebar .nav-link i {
        width: 20px;
        margin-right: 10px;
        text-align: center;
        flex-shrink: 0;
      }

      .main-content {
        margin-left: var(--sidebar-width);
        padding: 20px;
        transition: all 0.3s;
      }

      .sidebar-resize-hint {
        font-size: 0.75rem;
        opacity: 0.7;
        text-align: center;
      }

      .product-card {
        cursor: pointer;
        transition: all 0.2s;
        height: 100%;
        padding: 9px;
        font-size: 15px;
        font-weight: 600;
        margin-bottom: 6px;
      }

      .product-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }

      .product-card-img {
        width: 100%;
        height: 120px;
        object-fit: cover;
        border-radius: 0.375rem;
        margin-bottom: 8px;
        background: #f8f9fa;
      }

      .product-thumb {
        width: 48px;
        height: 48px;
        object-fit: cover;
        border-radius: 0.375rem;
        border: 1px solid #dee2e6;
        background: #f8f9fa;
      }

      .product-photo-preview {
        max-width: 150px;
        max-height: 150px;
        border-radius: 0.5rem;
        border: 1px solid #dee2e6;
        object-fit: cover;
      }

      #cart-items {
        max-height: 45vh;
        overflow-y: auto;
      }

      .pos-cart-sticky {
        position: sticky;
        top: 20px;
      }

      .pos-products-scroll {
        max-height: calc(100vh - 260px);
        overflow-y: auto;
        overflow-x: hidden;
        padding-right: 4px;
      }

      .card-stat {
        border-left: 4px solid var(--primary-color);
      }

      @media (max-width: 768px) {
        .sidebar {
          margin-left: -var(--sidebar-width);
        }

        .sidebar.active {
          margin-left: 0;
        }

        .main-content {
          margin-left: 0;
        }

        .main-content.active {
          margin-left: var(--sidebar-width);
        }
      }

      /* Custom scrollbar */
      ::-webkit-scrollbar {
        width: 8px;
      }

      ::-webkit-scrollbar-track {
        background: #f1f1f1;
      }

      ::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 4px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: #555;
      }

      /* Toast notifications */
      .toast-container {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 9999;
      }

      .toast {
        min-width: 300px;
        margin-bottom: 10px;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
      }

      #toast-container {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 9999;
        pointer-events: none;
      }

      #toast-container .alert {
        pointer-events: auto;
      }
    </style>
  </head>

  <body>
    <!-- Sidebar Toggle Button (Mobile) -->
    <button
      class="btn btn-primary d-md-none position-fixed"
      style="z-index: 1100; top: 10px; left: 10px"
      onclick="toggleSidebar()"
    >
      <i class="bi bi-list"></i>
    </button>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
      <div class="p-3">
        <h4 class="text-center">{{ pos_name }}</h4>
        <hr />
        <div class="text-center mb-3">
          <span
            >Welcome,
            <strong id="username-display">{{ session.username }}</strong></span
          >
        </div>
        <div class="sidebar-resize-hint">â‡” Drag right edge to resize</div>
      </div>
      <ul class="nav flex-column">
        <li class="nav-item">
          <a
            class="nav-link active"
            href="#"
            onclick="showSection('dashboard')"
          >
            <i class="bi bi-speedometer2"></i>Dashboard
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#" onclick="showSection('pos')">
            <i class="bi bi-cash-coin"></i>POS
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#" onclick="showSection('products')">
            <i class="bi bi-box-seam"></i>Products
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#" onclick="showSection('sales')">
            <i class="bi bi-receipt"></i>Sales
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#" onclick="showSection('reports')">
            <i class="bi bi-graph-up"></i>Reports
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#" onclick="showSection('promotions')">
            <i class="bi bi-tag"></i> Promotions
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#" onclick="showSection('customers')">
            <i class="bi bi-people"></i> Customers
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#" onclick="showSection('debts')">
            <i class="bi bi-credit-card"></i> Debts
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#" onclick="showSection('suppliers')">
            <i class="bi bi-truck"></i> Suppliers
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#" onclick="showSection('purchases')">
            <i class="bi bi-box-arrow-in-down"></i> Purchases
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#" onclick="showSection('users')">
            <i class="bi bi-people"></i>Users
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#" onclick="showSection('settings')">
            <i class="bi bi-gear"></i>Settings
          </a>
        </li>
        <li class="nav-item mt-3">
          <a class="nav-link text-danger" href="/logout">
            <i class="bi bi-box-arrow-right"></i>Logout
          </a>
        </li>
      </ul>
      <div class="sidebar-drag-handle" id="sidebar-drag-handle" title="Drag to resize sidebar"></div>
    </div>

    <!-- Main Content -->
    <div class="main-content" id="main-content">
      <!-- Dashboard Section -->
      <div id="dashboard-section">
        <h2>Dashboard</h2>
        <div class="row mt-4">
          <div class="col-md-4 mb-3">
            <div class="card card-stat bg-white">
              <div class="card-body">
                <h5 class="card-title">Today's Sales</h5>
                <h3 id="today-sales">$0.00</h3>
                <p class="text-muted mb-0">
                  <i class="bi bi-arrow-up text-success"></i>
                  <span id="sales-change">0%</span> from yesterday
                </p>
              </div>
            </div>
          </div>
          <div class="col-md-4 mb-3">
            <div class="card card-stat bg-white">
              <div class="card-body">
                <h5 class="card-title">Total Products</h5>
                <h3 id="total-products">0</h3>
                <p class="text-muted mb-0">
                  <span id="low-stock-count">0</span> low stock items
                </p>
              </div>
            </div>
          </div>
          <div class="col-md-4 mb-3">
            <div class="card card-stat bg-white">
              <div class="card-body">
                <h5 class="card-title">Recent Transactions</h5>
                <h3 id="recent-transactions">0</h3>
                <p class="text-muted mb-0">Last 24 hours</p>
              </div>
            </div>
          </div>
        </div>

        <div class="row mt-4">
          <div class="col-md-8">
            <div class="card">
              <div class="card-header bg-white">
                <h5 class="mb-0">Sales Overview</h5>
              </div>
              <div class="card-body">
                <canvas id="dashboardChart" height="250"></canvas>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card">
              <div class="card-header bg-white">
                <h5 class="mb-0">Top Products</h5>
              </div>
              <div class="card-body">
                <div id="top-products-list" class="list-group">
                  <!-- Top products will be loaded here -->
                  <div class="text-center text-muted py-3">Loading...</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- POS Section -->
      <div id="pos-section" style="display: none">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h2 class="mb-0">Point of Sale</h2>
          <button class="btn btn-outline-secondary" onclick="clearCart()">
            <i class="bi bi-x-circle"></i> Clear Cart
          </button>
        </div>

        <div class="row">
          <div class="col-md-8">
            <!-- Add customer selection here -->
            <div class="card mb-3">
              <div class="card-body">
                <div class="row">
                  <div class="col-md-8">
                    <label class="form-label">Customer (Optional)</label>
                    <select class="form-select" id="pos-customer-select">
                      <option value="">Walk-in Customer</option>
                    </select>
                  </div>
                  <div class="col-md-4 d-flex align-items-end">
                    <button class="btn btn-outline-primary w-100" onclick="showCustomerDetails()">
                      <i class="bi bi-person"></i> View Details
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <div class="input-group mb-3">
              <input
                type="text"
                id="product-search"
                class="form-control"
                placeholder="Scan barcode or search products..."
                autofocus
              />
              <button
                class="btn btn-primary"
                type="button"
                onclick="searchProducts()"
              >
                <i class="bi bi-search"></i> Search
              </button>
            </div>
            <div class="pos-products-scroll">
              <div class="row" id="product-grid">
                <!-- Products will be loaded here -->
                <div class="col-12 text-center py-5">
                  <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-4 pos-cart-sticky">
            <div class="card shadow">
              <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0">Current Sale</h5>
              </div>
              <div class="card-body">
                <div id="cart-items" class="mb-3">
                  <!-- Cart items will be displayed here -->
                  <p class="text-muted text-center py-3">No items added</p>
                </div>
                <hr />
                <div class="d-flex justify-content-between mb-2">
                  <span>Subtotal:</span>
                  <span id="subtotal">$0.00</span>
                </div>
                <div class="d-flex justify-content-between mb-2">
                  <span>Tax:</span>
                  <span id="tax">$0.00</span>
                </div>
                <div class="d-flex justify-content-between mb-3 fw-bold">
                  <span>Total:</span>
                  <span id="total">$0.00</span>
                </div>
                <hr />
                <div class="mb-3">
                  <label class="form-label">Payment Method</label>
                  <select id="payment-method" class="form-select">
                    <option value="cash">Cash</option>
                    <option value="credit_card">Credit Card</option>
                    <option value="debit_card">Debit Card</option>
                    <option value="mobile_payment">Mobile Payment</option>
                    <option value="debt">Charge to Customer</option>
                  </select>
                </div>
                <div class="mb-3" id="cash-payment-fields">
                  <label class="form-label">Cash Received</label>
                  <input
                    type="number"
                    min="0"
                    step="0.01"
                    id="cash-received"
                    class="form-control"
                    placeholder="0.00"
                    oninput="updateCashRefundDisplay()"
                  />
                  <div class="d-flex justify-content-between mt-2">
                    <small class="text-muted">Refund / Change:</small>
                    <small class="fw-bold" id="refund-amount">$0.00</small>
                  </div>
                </div>
                <button
                  class="btn btn-success w-100 py-2"
                  onclick="completeSale()"
                >
                  <i class="bi bi-check-circle"></i> Complete Sale
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Products Section -->
      <div id="products-section" style="display: none">
        <div
          class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2"
        >
          <h2 class="mb-0">Product Management</h2>
          <div class="d-flex gap-2">
            <button
              class="btn btn-primary"
              data-bs-toggle="modal"
              data-bs-target="#addProductModal"
            >
              <i class="bi bi-plus-circle"></i> Add Product
            </button>
            <button class="btn btn-success" onclick="showBarcodeLabelDialog()">
              <i class="bi bi-upc-scan"></i> Print Barcode Labels
            </button>
          </div>
        </div>

        <div class="card">
          <div class="card-body">
            <div class="row mb-3">
              <div class="col-md-5">
                <input
                  type="text"
                  id="products-search"
                  class="form-control"
                  placeholder="Search by barcode, name or category"
                />
              </div>
            </div>
            <div class="table-responsive">
              <table class="table table-striped table-hover">
                <thead>
                  <tr>
                    <th>Photo</th>
                    <th>Barcode</th>
                    <th>Name</th>
                    <th>Price</th>
                    <th>Stock</th>
                    <th>Category</th>
                    <th>Tax Rate</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="products-table">
                  <!-- Products will be loaded here -->
                  <tr>
                    <td colspan="8" class="text-center py-4">
                      <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div id="products-pagination" class="d-flex justify-content-end mt-3"></div>
          </div>
        </div>
      </div>

      <!-- Sales Section -->
      <div id="sales-section" style="display: none">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h2 class="mb-0">Sales History</h2>
          <div class="input-group" style="width: 300px">
            <input type="date" id="sales-date-filter" class="form-control" />
            <button
              class="btn btn-outline-secondary"
              type="button"
              onclick="filterSalesByDate()"
            >
              <i class="bi bi-filter"></i> Filter
            </button>
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-md-5">
            <input
              type="text"
              id="sales-search"
              class="form-control"
              placeholder="Search by transaction ID, payment or user"
            />
          </div>
        </div>

        <div class="card">
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-striped table-hover">
                <thead>
                  <tr>
                    <th>Transaction ID</th>
                    <th>Date</th>
                    <th>Total</th>
                    <th>Refund</th>
                    <th>Payment</th>
                    <th>User</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="sales-table">
                  <!-- Sales will be loaded here -->
                  <tr>
                    <td colspan="7" class="text-center py-4">
                      <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div id="sales-pagination" class="d-flex justify-content-end mt-3"></div>
          </div>
        </div>
      </div>

      <!-- Users Section -->
      <div id="users-section" style="display: none">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h2 class="mb-0">User Management</h2>
          <button
            class="btn btn-primary"
            data-bs-toggle="modal"
            data-bs-target="#addUserModal"
          >
            <i class="bi bi-person-plus"></i> Add User
          </button>
        </div>

        <div class="row mb-3">
          <div class="col-md-5">
            <input
              type="text"
              id="users-search"
              class="form-control"
              placeholder="Search by username, role or ID"
            />
          </div>
        </div>

        <div class="card">
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-striped table-hover">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Username</th>
                    <th>Role</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="users-table">
                  <!-- Users will be loaded here -->
                  <tr>
                    <td colspan="4" class="text-center py-4">
                      <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div id="users-pagination" class="d-flex justify-content-end mt-3"></div>
          </div>
        </div>
      </div>

      <!-- Promotions Section -->
      <div id="promotions-section" style="display: none">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h2 class="mb-0">Promotions Management</h2>
          <button
            class="btn btn-primary"
            data-bs-toggle="modal"
            data-bs-target="#addPromotionModal"
          >
            <i class="bi bi-plus-circle"></i> Add Promotion
          </button>
        </div>
        <div class="row mb-3">
          <div class="col-md-5">
            <input
              type="text"
              id="promotions-search"
              class="form-control"
              placeholder="Search by product or discount type"
            />
          </div>
        </div>
        <div class="card">
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-striped table-hover">
                <thead>
                  <tr>
                    <th>Product</th>
                    <th>Discount</th>
                    <th>Start Date</th>
                    <th>End Date</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="promotions-table">
                  <tr>
                    <td colspan="6" class="text-center py-4">
                      <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div id="promotions-pagination" class="d-flex justify-content-end mt-3"></div>
          </div>
        </div>
      </div>

      <!-- Customers Section -->
      <div id="customers-section" style="display: none">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h2 class="mb-0">Customer Management</h2>
          <button
            class="btn btn-primary"
            data-bs-toggle="modal"
            data-bs-target="#addCustomerModal"
          >
            <i class="bi bi-person-plus"></i> Add Customer
          </button>
        </div>

        <div class="row mb-3">
          <div class="col-md-5">
            <input
              type="text"
              id="customers-search"
              class="form-control"
              placeholder="Search by name, phone or email"
            />
          </div>
        </div>

        <div class="card">
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-striped table-hover">
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Phone</th>
                    <th>Email</th>
                    <th>Total Debt</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="customers-table">
                  <!-- Customers will be loaded here -->
                  <tr>
                    <td colspan="5" class="text-center py-4">
                      <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div id="customers-pagination" class="d-flex justify-content-end mt-3"></div>
          </div>
        </div>
      </div>

      <!-- Debts Section -->
      <div id="debts-section" style="display: none">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h2 class="mb-0">Debt Management</h2>
          <button
            class="btn btn-primary"
            data-bs-toggle="modal"
            data-bs-target="#addDebtModal"
          >
            <i class="bi bi-plus-circle"></i> Add Debt
          </button>
        </div>

        <div class="row g-3 mb-3">
          <div class="col-md-4">
            <input
              type="text"
              id="debts-search"
              class="form-control"
              placeholder="Search customer, phone or notes"
            />
          </div>
          <div class="col-md-3">
            <select id="debts-type-filter" class="form-select">
              <option value="">All Types</option>
              <option value="debt">Debt</option>
              <option value="payment">Payment</option>
            </select>
          </div>
          <div class="col-md-3">
            <select id="debts-status-filter" class="form-select">
              <option value="">All Status</option>
              <option value="open">Open</option>
              <option value="closed">Closed</option>
            </select>
          </div>
          <div class="col-md-2 d-flex align-items-end">
            <button class="btn btn-outline-secondary w-100" onclick="loadDebts()">
              <i class="bi bi-search"></i> Apply
            </button>
          </div>
        </div>

        <div class="card">
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-striped table-hover">
                <thead>
                  <tr>
                    <th>Customer</th>
                    <th>Amount</th>
                    <th>Balance</th>
                    <th>Type</th>
                    <th>Date</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="debts-table">
                  <!-- Debts will be loaded here -->
                  <tr>
                    <td colspan="6" class="text-center py-4">
                      <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div id="debts-pagination" class="d-flex justify-content-end mt-3"></div>
          </div>
        </div>
      </div>

      <!-- Suppliers Section -->
      <div id="suppliers-section" style="display: none">
        <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
          <h2 class="mb-0">Supplier Management</h2>
          <div class="d-flex gap-2">
            <button class="btn btn-outline-secondary" onclick="clearSupplierFilters()">
              <i class="bi bi-x-circle"></i> Reset Filters
            </button>
            <button
              class="btn btn-primary"
              data-bs-toggle="modal"
              data-bs-target="#addSupplierModal"
            >
              <i class="bi bi-plus-circle"></i> Add Supplier
            </button>
          </div>
        </div>

        <div class="row g-3 mb-3">
          <div class="col-md-5">
            <label class="form-label">Search Supplier</label>
            <input
              type="text"
              class="form-control"
              id="supplier-search"
              placeholder="Name, contact person, phone or email"
            />
          </div>
          <div class="col-md-3">
            <label class="form-label">Status</label>
            <select class="form-select" id="supplier-status-filter">
              <option value="">All</option>
              <option value="active">Active</option>
              <option value="inactive">Inactive</option>
            </select>
          </div>
          <div class="col-md-2 d-flex align-items-end">
            <button class="btn btn-primary w-100" onclick="loadSuppliers()">
              <i class="bi bi-search"></i> Search
            </button>
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-md-3 mb-2">
            <div class="card bg-light">
              <div class="card-body py-2">
                <small class="text-muted">Total Suppliers</small>
                <h5 id="supplier-total-count" class="mb-0">0</h5>
              </div>
            </div>
          </div>
          <div class="col-md-3 mb-2">
            <div class="card bg-light">
              <div class="card-body py-2">
                <small class="text-muted">Active</small>
                <h5 id="supplier-active-count" class="mb-0 text-success">0</h5>
              </div>
            </div>
          </div>
          <div class="col-md-3 mb-2">
            <div class="card bg-light">
              <div class="card-body py-2">
                <small class="text-muted">Inactive</small>
                <h5 id="supplier-inactive-count" class="mb-0 text-danger">0</h5>
              </div>
            </div>
          </div>
          <div class="col-md-3 mb-2">
            <div class="card bg-light">
              <div class="card-body py-2">
                <small class="text-muted">Avg Lead Time</small>
                <h5 id="supplier-avg-lead-time" class="mb-0">0 days</h5>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-striped table-hover">
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Contact Person</th>
                    <th>Phone</th>
                    <th>Email</th>
                    <th>Payment Terms</th>
                    <th>Lead Time</th>
                    <th>Status</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="suppliers-table">
                  <tr>
                    <td colspan="8" class="text-center py-4">
                      <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div id="suppliers-pagination" class="d-flex justify-content-end mt-3"></div>
          </div>
        </div>
      </div>

      <!-- Purchases Section -->
      <div id="purchases-section" style="display: none">
        <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
          <h2 class="mb-0">Purchase & Receiving</h2>
          <button
            class="btn btn-primary"
            data-bs-toggle="modal"
            data-bs-target="#addPurchaseOrderModal"
            onclick="preparePurchaseOrderModal()"
          >
            <i class="bi bi-plus-circle"></i> Create Purchase Order
          </button>
        </div>

        <div class="row mb-3">
          <div class="col-md-5">
            <input
              type="text"
              id="purchase-orders-search"
              class="form-control"
              placeholder="Search by PO number, supplier or status"
            />
          </div>
        </div>

        <div class="card">
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-striped table-hover">
                <thead>
                  <tr>
                    <th>PO Number</th>
                    <th>Supplier</th>
                    <th>Status</th>
                    <th>Created</th>
                    <th>Items</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="purchase-orders-table">
                  <tr>
                    <td colspan="6" class="text-center py-4">
                      <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div id="purchase-orders-pagination" class="d-flex justify-content-end mt-3"></div>
          </div>
        </div>
      </div>

      <!-- Reports Section -->
      <div id="reports-section" style="display: none">
        <h2>Reports</h2>
        <div class="row mb-3">
          <div class="col-md-3">
            <label class="form-label">Start Date</label>
            <input type="date" id="start-date" class="form-control" />
          </div>
          <div class="col-md-3">
            <label class="form-label">End Date</label>
            <input type="date" id="end-date" class="form-control" />
          </div>
          <div class="col-md-3 d-flex align-items-end">
            <button class="btn btn-primary" onclick="generateReport()">
              <i class="bi bi-file-earmark-text"></i> Generate Report
            </button>
          </div>
          <div class="col-md-3 d-flex align-items-end">
            <button class="btn btn-outline-secondary" onclick="exportReport()">
              <i class="bi bi-download"></i> Export
            </button>
          </div>
        </div>

        <div class="row">
          <div class="col-md-8">
            <div class="card mb-3">
              <div class="card-header bg-white">
                <h5 class="mb-0">Sales Chart</h5>
              </div>
              <div class="card-body">
                <canvas id="salesChart" height="250"></canvas>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card mb-3">
              <div class="card-header bg-white">
                <h5 class="mb-0">Payment Methods</h5>
              </div>
              <div class="card-body">
                <canvas id="paymentChart" height="250"></canvas>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header bg-white">
            <h5 class="mb-0">Report Results</h5>
          </div>
          <div class="card-body">
            <div id="report-results">
              <!-- Report results will be displayed here -->
              <p class="text-muted text-center py-3">
                Select date range and generate report
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Settings Section -->
      <div id="settings-section" style="display: none">
        <h2>Settings</h2>
        <div class="card mt-3">
          <div class="card-body">
            <div class="mb-3">
              <label class="form-label">POS Name</label>
              <input type="text" class="form-control" id="settings-pos-name" readonly />
            </div>
            <div class="mb-3">
              <label class="form-label">Currency Type</label>
              <select class="form-select" id="settings-currency-code">
                <option value="USD">Dollar ($)</option>
                <option value="MMK">Myanmar Kyat (MMK)</option>
                <option value="THB">Thai Baht (Bh)</option>
              </select>
            </div>
            <button class="btn btn-primary" onclick="saveSettings()">
              <i class="bi bi-save"></i> Save Settings
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Add Product Modal -->
    <div
      class="modal fade"
      id="addProductModal"
      tabindex="-1"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Add New Product</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="add-product-form">
              <div class="mb-3">
                <label class="form-label"
                  >Barcode <small class="text-muted">(optional)</small></label
                >
                <input
                  type="text"
                  class="form-control"
                  id="add-barcode"
                  placeholder="Scan or enter barcode"
                />
              </div>
              <div class="mb-3">
                <label class="form-label"
                  >Product Name <span class="text-danger">*</span></label
                >
                <input
                  type="text"
                  class="form-control"
                  id="add-product-name"
                  required
                />
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label"
                    >Price <span class="text-danger">*</span></label
                  >
                  <div class="input-group">
                    <span class="input-group-text">$</span>
                    <input
                      type="number"
                      step="0.01"
                      class="form-control"
                      id="add-price"
                      required
                    />
                  </div>
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label">Cost</label>
                  <div class="input-group">
                    <span class="input-group-text">$</span>
                    <input
                      type="number"
                      step="0.01"
                      class="form-control"
                      id="add-cost"
                    />
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label"
                    >Stock <span class="text-danger">*</span></label
                  >
                  <input
                    type="number"
                    class="form-control"
                    id="add-stock"
                    required
                  />
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label">Tax Rate (%)</label>
                  <input
                    type="number"
                    step="0.01"
                    class="form-control"
                    id="add-tax-rate"
                    value="0.0"
                  />
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label">Category</label>
                <input
                  type="text"
                  class="form-control"
                  id="add-category"
                  placeholder="e.g., Electronics, Grocery"
                />
              </div>
              <div class="mb-3">
                <label class="form-label">Product Photo</label>
                <input
                  type="file"
                  class="form-control"
                  id="add-photo"
                  accept="image/*"
                  onchange="previewSelectedProductPhoto('add-photo', 'add-photo-preview')"
                />
                <div id="add-photo-preview-wrapper" class="mt-2" style="display: none">
                  <img id="add-photo-preview" class="product-photo-preview" alt="Photo preview" />
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button
              type="button"
              class="btn btn-primary"
              onclick="saveProduct()"
            >
              Save Product
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit Product Modal -->
    <div
      class="modal fade"
      id="editProductModal"
      tabindex="-1"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Edit Product</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="edit-product-form">
              <input type="hidden" id="edit-product-id" />
              <div class="mb-3">
                <label class="form-label"
                  >Barcode <small class="text-muted">(optional)</small></label
                >
                <input type="text" class="form-control" id="edit-barcode" />
              </div>
              <div class="mb-3">
                <label class="form-label"
                  >Product Name <span class="text-danger">*</span></label
                >
                <input
                  type="text"
                  class="form-control"
                  id="edit-product-name"
                  required
                />
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label"
                    >Price <span class="text-danger">*</span></label
                  >
                  <div class="input-group">
                    <span class="input-group-text">$</span>
                    <input
                      type="number"
                      step="0.01"
                      class="form-control"
                      id="edit-price"
                      required
                    />
                  </div>
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label">Cost</label>
                  <div class="input-group">
                    <span class="input-group-text">$</span>
                    <input
                      type="number"
                      step="0.01"
                      class="form-control"
                      id="edit-cost"
                    />
                  </div>
                </div>
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label"
                    >Stock <span class="text-danger">*</span></label
                  >
                  <input
                    type="number"
                    class="form-control"
                    id="edit-stock"
                    required
                  />
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label">Tax Rate (%)</label>
                  <input
                    type="number"
                    step="0.01"
                    class="form-control"
                    id="edit-tax-rate"
                  />
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label">Category</label>
                <input type="text" class="form-control" id="edit-category" />
              </div>
              <div class="mb-3">
                <label class="form-label">Product Photo</label>
                <input
                  type="file"
                  class="form-control"
                  id="edit-photo"
                  accept="image/*"
                  onchange="previewSelectedProductPhoto('edit-photo', 'edit-photo-preview')"
                />
                <div id="edit-photo-preview-wrapper" class="mt-2" style="display: none">
                  <img id="edit-photo-preview" class="product-photo-preview" alt="Photo preview" />
                </div>
                <div class="form-check mt-2">
                  <input class="form-check-input" type="checkbox" id="edit-remove-photo" />
                  <label class="form-check-label" for="edit-remove-photo">
                    Remove current photo
                  </label>
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button
              type="button"
              class="btn btn-primary"
              onclick="updateProduct()"
            >
              Update Product
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Add Promotion Modal -->
    <div
      class="modal fade"
      id="addPromotionModal"
      tabindex="-1"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Create Promotion</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="add-promotion-form">
              <div class="mb-3">
                <label class="form-label"
                  >Product <span class="text-danger">*</span></label
                >
                <select
                  class="form-select"
                  id="promotion-product-id"
                  required
                ></select>
              </div>
              <div class="mb-3">
                <label class="form-label">Discount Type</label>
                <select class="form-select" id="promotion-discount-type">
                  <option value="percent">Percentage Off</option>
                  <option value="fixed">Fixed Amount Off</option>
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label"
                  >Discount Value <span class="text-danger">*</span></label
                >
                <input
                  type="number"
                  step="0.01"
                  class="form-control"
                  id="promotion-discount-value"
                  required
                />
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label">Start Date</label>
                  <input
                    type="datetime-local"
                    class="form-control"
                    id="promotion-start-date"
                    required
                  />
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label">End Date</label>
                  <input
                    type="datetime-local"
                    class="form-control"
                    id="promotion-end-date"
                    required
                  />
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button
              type="button"
              class="btn btn-primary"
              onclick="savePromotion()"
            >
              Save Promotion
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Barcode Label Modal -->
    <div
      class="modal fade"
      id="barcodeLabelModal"
      tabindex="-1"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Generate Barcode Labels</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div class="alert alert-info">
              <i class="bi bi-info-circle"></i> Select products to generate
              barcode labels. Labels will be printed 3 per row with the product
              name and price.
            </div>

            <div class="table-responsive">
              <table class="table table-striped table-hover">
                <thead>
                  <tr>
                    <th width="50px">
                      <input
                        type="checkbox"
                        id="select-all-products"
                        onclick="toggleSelectAllProducts()"
                      />
                    </th>
                    <th>Barcode</th>
                    <th>Name</th>
                    <th>Price</th>
                    <th>Stock</th>
                  </tr>
                </thead>
                <tbody id="barcode-products-table">
                  <!-- Products will be loaded here -->
                  <tr>
                    <td colspan="5" class="text-center py-4">
                      <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button
              type="button"
              class="btn btn-primary"
              onclick="generateBarcodeLabels()"
            >
              <i class="bi bi-printer"></i> Generate Labels
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Sale Details Modal -->
    <div
      class="modal fade"
      id="saleDetailsModal"
      tabindex="-1"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              Sale Details - <span id="sale-id-display"></span>
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body" id="sale-details-content">
            <!-- Sale details will be loaded here -->
            <div class="text-center py-4">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Close
            </button>
            <button
              type="button"
              class="btn btn-primary"
              onclick="printReceipt()"
            >
              <i class="bi bi-printer"></i> Print Receipt
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Return / Exchange Modal -->
    <div class="modal fade" id="returnExchangeModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Return / Exchange - <span id="return-exchange-sale-id"></span></h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="row g-3">
              <div class="col-md-6">
                <div class="card h-100">
                  <div class="card-header d-flex justify-content-between align-items-center">
                    <strong>Return Items (from original sale)</strong>
                    <button class="btn btn-sm btn-outline-primary" onclick="addReturnItemRow()"><i class="bi bi-plus"></i> Add</button>
                  </div>
                  <div class="card-body" id="return-items-container"></div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="card h-100">
                  <div class="card-header d-flex justify-content-between align-items-center">
                    <strong>Exchange Items (new products)</strong>
                    <button class="btn btn-sm btn-outline-primary" onclick="addExchangeItemRow()"><i class="bi bi-plus"></i> Add</button>
                  </div>
                  <div class="card-body" id="exchange-items-container"></div>
                </div>
              </div>
            </div>

            <div class="row mt-3 g-3">
              <div class="col-md-4">
                <label class="form-label">Settlement Method</label>
                <select class="form-select" id="return-exchange-settlement-method">
                  <option value="cash">Cash</option>
                  <option value="credit_card">Credit Card</option>
                  <option value="debit_card">Debit Card</option>
                  <option value="mobile_payment">Mobile Payment</option>
                </select>
              </div>
              <div class="col-md-8">
                <label class="form-label">Notes</label>
                <input class="form-control" id="return-exchange-notes" placeholder="Reason, condition, etc." />
              </div>
            </div>

            <div class="alert alert-secondary mt-3 mb-0" id="return-exchange-summary">
              Return: <strong id="summary-return-total">$0.00</strong> |
              Exchange: <strong id="summary-exchange-total">$0.00</strong> |
              Net: <strong id="summary-net-total">$0.00</strong>
              <span class="ms-2" id="summary-settlement-hint"></span>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="button" class="btn btn-warning" onclick="submitReturnExchange()">
              <i class="bi bi-arrow-left-right"></i> Process Return / Exchange
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Add User Modal -->
    <div class="modal fade" id="addUserModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Add New User</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="add-user-form">
              <div class="mb-3">
                <label class="form-label"
                  >Username <span class="text-danger">*</span></label
                >
                <input
                  type="text"
                  class="form-control"
                  id="add-username"
                  required
                />
              </div>
              <div class="mb-3">
                <label class="form-label"
                  >Password <span class="text-danger">*</span></label
                >
                <input
                  type="password"
                  class="form-control"
                  id="add-password"
                  required
                />
              </div>
              <div class="mb-3">
                <label class="form-label"
                  >Confirm Password <span class="text-danger">*</span></label
                >
                <input
                  type="password"
                  class="form-control"
                  id="add-confirm-password"
                  required
                />
              </div>
              <div class="mb-3">
                <label class="form-label"
                  >Role <span class="text-danger">*</span></label
                >
                <select class="form-select" id="add-role" required>
                  <option value="cashier">Cashier</option>
                  <option value="manager">Manager</option>
                </select>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button type="button" class="btn btn-primary" onclick="saveUser()">
              Save User
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit User Modal -->
    <div class="modal fade" id="editUserModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Edit User</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="edit-user-form">
              <input type="hidden" id="edit-user-id" />
              <div class="mb-3">
                <label class="form-label"
                  >Username <span class="text-danger">*</span></label
                >
                <input
                  type="text"
                  class="form-control"
                  id="edit-username"
                  required
                />
              </div>
              <div class="mb-3">
                <label class="form-label"
                  >Password (leave blank to keep current)</label
                >
                <input
                  type="password"
                  class="form-control"
                  id="edit-password"
                />
              </div>
              <div class="mb-3">
                <label class="form-label">Confirm Password</label>
                <input
                  type="password"
                  class="form-control"
                  id="edit-confirm-password"
                />
              </div>
              <div class="mb-3">
                <label class="form-label"
                  >Role <span class="text-danger">*</span></label
                >
                <select class="form-select" id="edit-role" required>
                  <option value="cashier">Cashier</option>
                  <option value="manager">Manager</option>
                </select>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button
              type="button"
              class="btn btn-primary"
              onclick="updateUser()"
            >
              Update User
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Add Customer Modal -->
    <div
      class="modal fade"
      id="addCustomerModal"
      tabindex="-1"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Add New Customer</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="add-customer-form">
              <div class="mb-3">
                <label class="form-label"
                  >Name <span class="text-danger">*</span></label
                >
                <input
                  type="text"
                  class="form-control"
                  id="add-customer-name"
                  required
                />
              </div>
              <div class="mb-3">
                <label class="form-label">Phone</label>
                <input
                  type="text"
                  class="form-control"
                  id="add-customer-phone"
                />
              </div>
              <div class="mb-3">
                <label class="form-label">Email</label>
                <input
                  type="email"
                  class="form-control"
                  id="add-customer-email"
                />
              </div>
              <div class="mb-3">
                <label class="form-label">Address</label>
                <textarea
                  class="form-control"
                  id="add-customer-address"
                  rows="3"
                ></textarea>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button
              type="button"
              class="btn btn-primary"
              onclick="saveCustomer()"
            >
              Save Customer
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit Customer Modal -->
    <div
      class="modal fade"
      id="editCustomerModal"
      tabindex="-1"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Edit Customer</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="edit-customer-form">
              <input type="hidden" id="edit-customer-id" />
              <div class="mb-3">
                <label class="form-label"
                  >Name <span class="text-danger">*</span></label
                >
                <input
                  type="text"
                  class="form-control"
                  id="edit-customer-name"
                  required
                />
              </div>
              <div class="mb-3">
                <label class="form-label">Phone</label>
                <input
                  type="text"
                  class="form-control"
                  id="edit-customer-phone"
                />
              </div>
              <div class="mb-3">
                <label class="form-label">Email</label>
                <input
                  type="email"
                  class="form-control"
                  id="edit-customer-email"
                />
              </div>
              <div class="mb-3">
                <label class="form-label">Address</label>
                <textarea
                  class="form-control"
                  id="edit-customer-address"
                  rows="3"
                ></textarea>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button
              type="button"
              class="btn btn-primary"
              onclick="updateCustomer()"
            >
              Update Customer
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Add Debt Modal -->
    <div
      class="modal fade"
      id="addDebtModal"
      tabindex="-1"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Add Debt Record</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="add-debt-form">
              <div class="mb-3">
                <label class="form-label"
                  >Customer <span class="text-danger">*</span></label
                >
                <select class="form-select" id="debt-customer-id" required>
                  <option value="">Select a customer</option>
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label"
                  >Amount <span class="text-danger">*</span></label
                >
                <div class="input-group">
                  <span class="input-group-text">$</span>
                  <input
                    type="number"
                    step="0.01"
                    class="form-control"
                    id="debt-amount"
                    required
                  />
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label">Notes</label>
                <textarea
                  class="form-control"
                  id="debt-notes"
                  rows="3"
                ></textarea>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button
              type="button"
              class="btn btn-primary"
              onclick="saveDebt()"
            >
              Save Debt
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Make Payment Modal -->
    <div
      class="modal fade"
      id="makePaymentModal"
      tabindex="-1"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Make Payment</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="make-payment-form">
              <input type="hidden" id="payment-debt-id" />
              <div class="mb-3">
                <label class="form-label">Customer</label>
                <input
                  type="text"
                  class="form-control"
                  id="payment-customer-name"
                  readonly
                />
              </div>
              <div class="mb-3">
                <label class="form-label">Original Amount</label>
                <div class="input-group">
                  <span class="input-group-text">$</span>
                  <input
                    type="text"
                    class="form-control"
                    id="payment-original-amount"
                    readonly
                  />
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label">Remaining Balance</label>
                <div class="input-group">
                  <span class="input-group-text">$</span>
                  <input
                    type="text"
                    class="form-control"
                    id="payment-balance"
                    readonly
                  />
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label"
                  >Payment Amount <span class="text-danger">*</span></label
                >
                <div class="input-group">
                  <span class="input-group-text">$</span>
                  <input
                    type="number"
                    step="0.01"
                    class="form-control"
                    id="payment-amount"
                    required
                  />
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label">Notes</label>
                <textarea
                  class="form-control"
                  id="payment-notes"
                  rows="3"
                ></textarea>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button
              type="button"
              class="btn btn-primary"
              onclick="makePayment()"
            >
              Make Payment
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Add Supplier Modal -->
    <div
      class="modal fade"
      id="addSupplierModal"
      tabindex="-1"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Add Supplier</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="add-supplier-form">
              <div class="mb-3">
                <label class="form-label"
                  >Supplier Name <span class="text-danger">*</span></label
                >
                <input
                  type="text"
                  class="form-control"
                  id="add-supplier-name"
                  required
                />
              </div>
              <div class="mb-3">
                <label class="form-label">Contact Person</label>
                <input
                  type="text"
                  class="form-control"
                  id="add-supplier-contact"
                />
              </div>
              <div class="mb-3">
                <label class="form-label">Phone</label>
                <input
                  type="text"
                  class="form-control"
                  id="add-supplier-phone"
                />
              </div>
              <div class="mb-3">
                <label class="form-label">Email</label>
                <input
                  type="email"
                  class="form-control"
                  id="add-supplier-email"
                />
              </div>
              <div class="mb-3">
                <label class="form-label">Address</label>
                <textarea
                  class="form-control"
                  id="add-supplier-address"
                  rows="3"
                ></textarea>
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label">Payment Terms</label>
                  <input
                    type="text"
                    class="form-control"
                    id="add-supplier-payment-terms"
                    placeholder="e.g. Net 30"
                  />
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label">Lead Time (Days)</label>
                  <input
                    type="number"
                    min="0"
                    class="form-control"
                    id="add-supplier-lead-time"
                    placeholder="e.g. 7"
                  />
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label">Notes</label>
                <textarea
                  class="form-control"
                  id="add-supplier-notes"
                  rows="2"
                  placeholder="Preferred delivery time, quality notes, etc."
                ></textarea>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="add-supplier-is-active" checked />
                <label class="form-check-label" for="add-supplier-is-active">
                  Active supplier
                </label>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button
              type="button"
              class="btn btn-primary"
              onclick="saveSupplier()"
            >
              Save Supplier
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit Supplier Modal -->
    <div
      class="modal fade"
      id="editSupplierModal"
      tabindex="-1"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Edit Supplier</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="edit-supplier-form">
              <input type="hidden" id="edit-supplier-id" />
              <div class="mb-3">
                <label class="form-label"
                  >Supplier Name <span class="text-danger">*</span></label
                >
                <input
                  type="text"
                  class="form-control"
                  id="edit-supplier-name"
                  required
                />
              </div>
              <div class="mb-3">
                <label class="form-label">Contact Person</label>
                <input
                  type="text"
                  class="form-control"
                  id="edit-supplier-contact"
                />
              </div>
              <div class="mb-3">
                <label class="form-label">Phone</label>
                <input
                  type="text"
                  class="form-control"
                  id="edit-supplier-phone"
                />
              </div>
              <div class="mb-3">
                <label class="form-label">Email</label>
                <input
                  type="email"
                  class="form-control"
                  id="edit-supplier-email"
                />
              </div>
              <div class="mb-3">
                <label class="form-label">Address</label>
                <textarea
                  class="form-control"
                  id="edit-supplier-address"
                  rows="3"
                ></textarea>
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label">Payment Terms</label>
                  <input
                    type="text"
                    class="form-control"
                    id="edit-supplier-payment-terms"
                    placeholder="e.g. Net 30"
                  />
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label">Lead Time (Days)</label>
                  <input
                    type="number"
                    min="0"
                    class="form-control"
                    id="edit-supplier-lead-time"
                  />
                </div>
              </div>
              <div class="mb-3">
                <label class="form-label">Notes</label>
                <textarea
                  class="form-control"
                  id="edit-supplier-notes"
                  rows="2"
                ></textarea>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="edit-supplier-is-active" />
                <label class="form-check-label" for="edit-supplier-is-active">
                  Active supplier
                </label>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button
              type="button"
              class="btn btn-primary"
              onclick="updateSupplier()"
            >
              Update Supplier
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Customer Details Modal -->
    <div
      class="modal fade"
      id="customerDetailsModal"
      tabindex="-1"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Customer Details</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body" id="customer-details-content">
            <!-- Customer details will be loaded here -->
            <div class="text-center py-4">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Add Purchase Order Modal -->
    <div
      class="modal fade"
      id="addPurchaseOrderModal"
      tabindex="-1"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Create Purchase Order</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">Supplier <span class="text-danger">*</span></label>
              <select class="form-select" id="po-supplier-id">
                <option value="">Select supplier</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Notes</label>
              <textarea class="form-control" id="po-notes" rows="2"></textarea>
            </div>
            <hr />
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h6 class="mb-0">Items</h6>
              <button class="btn btn-sm btn-outline-primary" onclick="addPurchaseOrderItemRow()">
                <i class="bi bi-plus"></i> Add Item
              </button>
            </div>
            <div id="po-items-container"></div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button type="button" class="btn btn-primary" onclick="savePurchaseOrder()">
              Create PO
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Receive Purchase Order Modal -->
    <div
      class="modal fade"
      id="receivePurchaseOrderModal"
      tabindex="-1"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Receive Purchase Order</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <p class="mb-2">PO: <strong id="receive-po-number">-</strong></p>
            <div id="receive-po-items-container"></div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button type="button" class="btn btn-success" onclick="submitPurchaseReceiving()">
              Confirm Receiving
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      // Global variables
      const APP_SETTINGS = {
        posName: "{{ pos_name }}",
        currencyCode: "{{ currency_code }}",
        currencySuffix: "{{ currency_suffix }}",
      };

      function currencySuffixFromCode(code) {
        const map = { USD: "$", MMK: "MMK", THB: "Bh" };
        return map[code] || "$";
      }

      function formatCurrencyWithSymbol(value, symbol) {
        const amount = Number(value) || 0;
        const currencySymbol = symbol || "$";
        return `${amount.toFixed(2)} ${currencySymbol}`;
      }

      function formatCurrency(value) {
        return formatCurrencyWithSymbol(value, APP_SETTINGS.currencySuffix);
      }

      function normalizeCurrencyInText(text) {
        return text
          .replace(/\$\s*(-?\d+(?:\.\d+)?)/g, (_, amount) =>
            formatCurrencyWithSymbol(amount, APP_SETTINGS.currencySuffix)
          )
          .replace(/\b([A-Za-z]{2,5})\s*(-?\d+(?:\.\d+)?)\b/g, (_, symbol, amount) =>
            formatCurrencyWithSymbol(amount, symbol)
          )
          .replace(/(-?\d+(?:\.\d+)?)\$/g, (_, amount) =>
            formatCurrencyWithSymbol(amount, APP_SETTINGS.currencySuffix)
          );
      }

      function normalizeCurrencyDisplay(root = document.body) {
        if (!root) return;

        const isCurrencyToken = (token) => {
          const value = String(token || "").trim();
          return value === "$" || value === "MMK" || value === "Bh";
        };

        const walker = document.createTreeWalker(root, NodeFilter.SHOW_TEXT, null);
        const nodes = [];
        let node;
        while ((node = walker.nextNode())) {
          const parentTag = node.parentElement?.tagName;
          if (parentTag === "SCRIPT" || parentTag === "STYLE") continue;
          if (node.nodeValue && node.nodeValue.includes("$")) {
            nodes.push(node);
          }
        }

        nodes.forEach((textNode) => {
          textNode.nodeValue = normalizeCurrencyInText(textNode.nodeValue);
        });

        document.querySelectorAll(".input-group-text").forEach((el) => {
          if (isCurrencyToken(el.textContent.trim())) {
            el.textContent = APP_SETTINGS.currencySuffix;
          }
        });

        document.querySelectorAll(".input-group").forEach((group) => {
          const first = group.firstElementChild;
          const second = first?.nextElementSibling;
          if (
            first &&
            first.classList.contains("input-group-text") &&
            second &&
            (second.tagName === "INPUT" || second.tagName === "TEXTAREA") &&
            isCurrencyToken(first.textContent.trim())
          ) {
            group.appendChild(first);
          }
        });
      }

      function startCurrencyObserver() {
        if (!window.MutationObserver) return;

        let scheduled = false;
        const pendingRoots = new Set();

        const flush = () => {
          scheduled = false;
          pendingRoots.forEach((root) => normalizeCurrencyDisplay(root));
          pendingRoots.clear();
        };

        const observer = new MutationObserver((mutations) => {
          mutations.forEach((mutation) => {
            mutation.addedNodes.forEach((node) => {
              if (node.nodeType === Node.ELEMENT_NODE) {
                pendingRoots.add(node);
              }
            });
          });

          if (!scheduled && pendingRoots.size > 0) {
            scheduled = true;
            requestAnimationFrame(flush);
          }
        });

        observer.observe(document.body, { childList: true, subtree: true });
      }

      function applySettingsUI() {
        document.title = `${APP_SETTINGS.posName} Dashboard`;
        const sidebarTitle = document.querySelector(".sidebar h4");
        if (sidebarTitle) sidebarTitle.textContent = APP_SETTINGS.posName;

        const posNameInput = document.getElementById("settings-pos-name");
        if (posNameInput) posNameInput.value = APP_SETTINGS.posName;

        const currencySelect = document.getElementById("settings-currency-code");
        if (currencySelect) currencySelect.value = APP_SETTINGS.currencyCode;

        normalizeCurrencyDisplay();
      }

      function loadSettings() {
        fetch("/api/settings")
          .then((response) => response.json())
          .then((data) => {
            APP_SETTINGS.posName = data.pos_name || APP_SETTINGS.posName;
            APP_SETTINGS.currencyCode = data.currency_code || APP_SETTINGS.currencyCode;
            APP_SETTINGS.currencySuffix = data.currency_suffix || currencySuffixFromCode(APP_SETTINGS.currencyCode);
            applySettingsUI();
          })
          .catch((error) => {
            console.error("Error loading settings:", error);
            applySettingsUI();
          });
      }

      function saveSettings() {
        const currencyCode = document.getElementById("settings-currency-code")?.value;
        if (!currencyCode) return;

        fetch("/api/settings", {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ currency_code: currencyCode }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (!data.success) {
              alert(data.message || "Failed to save settings");
              return;
            }

            APP_SETTINGS.currencyCode = data.currency_code;
            APP_SETTINGS.currencySuffix = data.currency_suffix || currencySuffixFromCode(data.currency_code);
            applySettingsUI();
            alert("Settings updated successfully");
          })
          .catch((error) => {
            console.error("Error saving settings:", error);
            alert("Failed to save settings");
          });
      }
      let cart = [];
      let currentSection = "dashboard";
      let currentProduct = null;
      let currentSupplier = null;
      let dashboardChart = null;
      let salesChart = null;
      let paymentChart = null;
      let returnExchangeSaleData = null;
      const pageState = {
        products: 1,
        sales: 1,
        users: 1,
        promotions: 1,
        customers: 1,
        debts: 1,
        suppliers: 1,
        purchases: 1,
      };
      const pageSize = {
        products: 10,
        sales: 10,
        users: 10,
        promotions: 10,
        customers: 10,
        debts: 10,
        suppliers: 10,
        purchases: 10,
      };
      
      // ===== CACHING IMPLEMENTATION =====
      // Product data caching to reduce API calls
      let cachedProducts = [];
      let productsCacheTimestamp = 0;
      const CACHE_DURATION = 60000; // 1 minute cache duration
      
      // Function to load products with caching
      async function loadProductsCached() {
        const now = Date.now();
        // If cache is still valid, return cached data
        if (cachedProducts.length > 0 && (now - productsCacheTimestamp) < CACHE_DURATION) {
          return cachedProducts;
        }
        
        // Otherwise, fetch fresh data
        try {
          const res = await fetch("/api/products");
          const data = await res.json();
          cachedProducts = data;
          productsCacheTimestamp = now;
          return data;
        } catch (error) {
          console.error("Error loading products:", error);
          // Return cached data even if it's expired, to avoid complete failure
          return cachedProducts;
        }
      }
      
      // Function to invalidate cache when needed (e.g., after adding/updating/deleting a product)
      function invalidateProductsCache() {
        cachedProducts = [];
        productsCacheTimestamp = 0;
      }
      // ===== END CACHING IMPLEMENTATION =====

      function paginateArray(data, key) {
        const totalItems = data.length;
        const totalPages = Math.max(1, Math.ceil(totalItems / pageSize[key]));
        if (pageState[key] > totalPages) pageState[key] = totalPages;
        if (pageState[key] < 1) pageState[key] = 1;

        const startIndex = (pageState[key] - 1) * pageSize[key];
        const endIndex = startIndex + pageSize[key];
        return {
          items: data.slice(startIndex, endIndex),
          totalPages,
          totalItems,
        };
      }

      function renderPagination(key, containerId, totalPages, onChange) {
        const container = document.getElementById(containerId);
        if (!container) return;
        if (totalPages <= 1) {
          container.innerHTML = "";
          return;
        }

        const current = pageState[key];
        container.innerHTML = `
          <nav>
            <ul class="pagination pagination-sm mb-0">
              <li class="page-item ${current <= 1 ? "disabled" : ""}">
                <a class="page-link" href="#" data-page="${current - 1}">Previous</a>
              </li>
              <li class="page-item disabled"><span class="page-link">${current} / ${totalPages}</span></li>
              <li class="page-item ${current >= totalPages ? "disabled" : ""}">
                <a class="page-link" href="#" data-page="${current + 1}">Next</a>
              </li>
            </ul>
          </nav>
        `;

        container.querySelectorAll("a.page-link[data-page]").forEach((link) => {
          link.addEventListener("click", (e) => {
            e.preventDefault();
            const target = parseInt(e.currentTarget.getAttribute("data-page"), 10);
            if (!Number.isNaN(target) && target >= 1 && target <= totalPages) {
              pageState[key] = target;
              onChange();
            }
          });
        });
      }

      // Initialize the application when page loads
      document.addEventListener("DOMContentLoaded", function () {
        initResizableSidebar();
        applySettingsUI();
        loadSettings();
        startCurrencyObserver();

        // Set today's date as default for sales filter
        const today = new Date().toISOString().split("T")[0];
        document.getElementById("sales-date-filter").value = today;

        // Set default date range for reports (last 7 days)
        const sevenDaysAgo = new Date();
        sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
        document.getElementById("start-date").value = sevenDaysAgo
          .toISOString()
          .split("T")[0];
        document.getElementById("end-date").value = today;

        // Load initial data
        loadDashboardStats();
        loadProducts();
        loadSales();

        // Set up product search to work on Enter key
        document
          .getElementById("product-search")
          .addEventListener("keypress", function (e) {
            if (e.key === "Enter") {
              searchProducts();
            }
          });

        const bindReload = (id, fn, key) => {
          const el = document.getElementById(id);
          if (!el) return;
          el.addEventListener("input", () => {
            if (key) pageState[key] = 1;
            fn();
          });
        };

        bindReload("products-search", loadProducts, "products");
        bindReload("sales-search", loadSales, "sales");
        bindReload("users-search", loadUsers, "users");
        bindReload("promotions-search", loadPromotions, "promotions");
        bindReload("customers-search", loadCustomers, "customers");
        bindReload("debts-search", loadDebts, "debts");
        bindReload("purchase-orders-search", loadPurchaseOrders, "purchases");

        ["debts-type-filter", "debts-status-filter"].forEach((id) => {
          const el = document.getElementById(id);
          if (!el) return;
          el.addEventListener("change", () => {
            pageState.debts = 1;
            loadDebts();
          });
        });

        const paymentMethodSelect = document.getElementById("payment-method");
        if (paymentMethodSelect) {
          paymentMethodSelect.addEventListener("change", function () {
            toggleCashPaymentFields();
            updateCashRefundDisplay();
          });
        }

        toggleCashPaymentFields();
        updateCashRefundDisplay();

        // NOTE:
        // A full-page MutationObserver was causing repeated DOM scans and could
        // make the dashboard become unresponsive on slower machines / large pages.
        // We keep currency normalization explicit (applySettingsUI / load flows)
        // instead of continuously reprocessing the whole document on each change.
      });

      // Toggle sidebar on mobile
      function toggleSidebar() {
        const sidebar = document.getElementById("sidebar");
        const mainContent = document.getElementById("main-content");
        sidebar.classList.toggle("active");
        mainContent.classList.toggle("active");
      }

      function initResizableSidebar() {
        const sidebar = document.getElementById("sidebar");
        const dragHandle = document.getElementById("sidebar-drag-handle");
        const root = document.documentElement;
        const minWidth = 220;
        const maxWidth = 420;

        const clampWidth = (width) => Math.min(maxWidth, Math.max(minWidth, width));
        const setSidebarWidth = (width) => {
          const safeWidth = clampWidth(Math.round(width));
          root.style.setProperty("--sidebar-width", `${safeWidth}px`);
          sidebar.style.width = `${safeWidth}px`;
          localStorage.setItem("pos_sidebar_width", String(safeWidth));
        };

        const savedSidebarWidth = parseInt(localStorage.getItem("pos_sidebar_width"), 10);
        setSidebarWidth(Number.isFinite(savedSidebarWidth) ? savedSidebarWidth : 250);

        let isDragging = false;

        if (dragHandle) {
          dragHandle.addEventListener("mousedown", (event) => {
            if (window.innerWidth <= 768) return;
            isDragging = true;
            event.preventDefault();
            document.body.style.cursor = "col-resize";
            document.body.style.userSelect = "none";
          });
        }

        document.addEventListener("mousemove", (event) => {
          if (!isDragging) return;
          setSidebarWidth(event.clientX);
        });

        document.addEventListener("mouseup", () => {
          if (!isDragging) return;
          isDragging = false;
          document.body.style.cursor = "";
          document.body.style.userSelect = "";
        });
      }

      // Show different sections
      function showSection(sectionId) {
        document.getElementById(currentSection + "-section").style.display =
          "none";
        document.querySelector(`.nav-link.active`).classList.remove("active");
        document.getElementById(sectionId + "-section").style.display = "block";
        document
          .querySelector(`[onclick="showSection('${sectionId}')"]`)
          .classList.add("active");
        currentSection = sectionId;

        // Load data for the section if needed
        if (sectionId === "pos") {
          loadProductsForPOS();
          loadCustomersForPOS();
        } else if (sectionId === "reports") {
          initSalesChart();
          initPaymentChart();
        } else if (sectionId === "products") {
          loadProducts();
        } else if (sectionId === "dashboard") {
          loadDashboardStats();
        } else if (sectionId === "users") {
          loadUsers();
        } else if (sectionId === "sales") {
          loadSales();
        } else if (sectionId === "promotions") {
          loadPromotions();
          loadProductsForPromotionModal();
        } else if (sectionId === "customers") {
          loadCustomers();
        } else if (sectionId === "debts") {
          loadDebts();
          loadCustomersForDebtModal();
        } else if (sectionId === "suppliers") {
          loadSuppliers();
        } else if (sectionId === "purchases") {
          loadPurchaseOrders();
        } else if (sectionId === "settings") {
          loadSettings();
        }

        // Scroll to top when switching sections
        window.scrollTo(0, 0);
      }

      // Add this function to check for authorization errors
      function checkAuthError(error) {
        if (error.message.includes("401") || error.message.includes("403")) {
          alert(
            "You do not have permission to access this feature. Please contact a manager."
          );
          return true;
        }
        return false;
      }

      // Update your fetch calls to use this check
      fetch("/api/users")
        .then((response) => {
          if (response.status === 401 || response.status === 403) {
            throw new Error("Unauthorized access");
          }
          return response.json();
        })
        .then((data) => {
          // process data
        })
        .catch((error) => {
          if (checkAuthError(error)) return;
          console.error("Error:", error);
          // show error to user
        });

      // Dashboard functions
      function loadDashboardStats() {
        // Today's sales
        fetch(
          "/api/reports/sales?start=" + new Date().toISOString().split("T")[0]
        )
          .then((response) => response.json())
          .then((data) => {
            const todaySales = data.reduce((sum, sale) => sum + sale.total, 0);
            document.getElementById("today-sales").textContent = formatCurrency(todaySales);

            // Calculate change from yesterday
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayStr = yesterday.toISOString().split("T")[0];

            fetch(
              `/api/reports/sales?start=${yesterdayStr}&end=${yesterdayStr}`
            )
              .then((response) => response.json())
              .then((yesterdayData) => {
                const yesterdaySales = yesterdayData.reduce(
                  (sum, sale) => sum + sale.total,
                  0
                );
                const change =
                  yesterdaySales > 0
                    ? ((todaySales - yesterdaySales) / yesterdaySales) * 100
                    : todaySales > 0
                    ? 100
                    : 0;

                const changeElement = document.getElementById("sales-change");
                changeElement.textContent = Math.abs(change).toFixed(1) + "%";
                if (change >= 0) {
                  changeElement.parentElement.innerHTML =
                    changeElement.parentElement.innerHTML.replace(
                      "bi-arrow-up",
                      "bi-arrow-up text-success"
                    );
                } else {
                  changeElement.parentElement.innerHTML =
                    changeElement.parentElement.innerHTML.replace(
                      "bi-arrow-up",
                      "bi-arrow-down text-danger"
                    );
                }
              })
              .catch((error) => {
                console.error("Error loading yesterday's sales:", error);
                document.getElementById("sales-change").textContent = "N/A";
              });
          });

        // Total products and low stock - USING CACHED PRODUCTS
        loadProductsCached().then((data) => {
          document.getElementById("total-products").textContent = data.length;
          const lowStock = data.filter((p) => p.stock < 5).length;
          document.getElementById("low-stock-count").textContent = lowStock;
        });

        // Recent transactions (last 24 hours) - FIXED
        const now = new Date();
        const twentyFourHoursAgo = new Date(
          now.getTime() - 24 * 60 * 60 * 1000
        );
        const startDate = twentyFourHoursAgo.toISOString().split("T")[0]; // Get YYYY-MM-DD format

        fetch(`/api/reports/sales?start=${startDate}`)
          .then((response) => {
            if (!response.ok) throw new Error("API request failed");
            return response.json();
          })
          .then((data) => {
            console.log("Recent transactions:", data.length, "sales"); // Debug
            document.getElementById("recent-transactions").textContent =
              data.length;
          })
          .catch((error) => {
            console.error("Error loading recent transactions:", error);
            document.getElementById("recent-transactions").textContent = "0";
          });

        // Initialize dashboard chart
        initDashboardChart();

        // Load top products - USING CACHED PRODUCTS
        loadTopProducts();
      }

      function initDashboardChart() {
        const ctx = document.getElementById("dashboardChart").getContext("2d");

        if (dashboardChart) {
          dashboardChart.destroy();
        }

        fetch("/api/dashboard/sales_data")
          .then((response) => response.json())
          .then((data) => {
            const labels = data.map((item) => {
              const date = new Date(item.date);
              return date.toLocaleDateString("en-US", { weekday: "short" });
            });
            const salesData = data.map((item) => item.total);

            dashboardChart = new Chart(ctx, {
              type: "line",
              data: {
                labels: labels,
                datasets: [
                  {
                    label: "Daily Sales ($)",
                    data: salesData,
                    backgroundColor: "rgba(13, 110, 253, 0.2)",
                    borderColor: "rgba(13, 110, 253, 1)",
                    borderWidth: 2,
                    tension: 0.4,
                    fill: true,
                  },
                ],
              },
              options: {
                responsive: true,
                plugins: {
                  legend: {
                    display: false,
                  },
                },
                scales: {
                  y: {
                    beginAtZero: true,
                  },
                },
              },
            });
          })
          .catch((error) => {
            console.error("Error loading dashboard sales data:", error);
            ctx.font = "16px Arial";
            ctx.fillStyle = "red";
            ctx.textAlign = "center";
            ctx.fillText(
              "Failed to load chart data",
              ctx.canvas.width / 2,
              ctx.canvas.height / 2
            );
          });
      }

      function loadPromotions() {
        const table = document.getElementById("promotions-table");
        table.innerHTML = `
          <tr>
            <td colspan="6" class="text-center py-4">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
            </td>
          </tr>
        `;

        fetch("/api/promotions")
          .then((r) => r.json())
          .then((data) => {
            table.innerHTML = "";
            const query = (document.getElementById("promotions-search")?.value || "")
              .trim()
              .toLowerCase();
            const filtered = (data || []).filter((p) => {
              if (!query) return true;
              return (
                String(p.product_name || "").toLowerCase().includes(query) ||
                String(p.discount_type || "").toLowerCase().includes(query)
              );
            });

            if (filtered.length === 0) {
              table.innerHTML = `
                <tr><td colspan="6" class="text-center py-4 text-muted">No promotions found.</td></tr>
              `;
              renderPagination("promotions", "promotions-pagination", 1, loadPromotions);
              return;
            }

            const page = paginateArray(filtered, "promotions");
            page.items.forEach((p) => {
              const startDate = new Date(p.start_date).toLocaleString();
              const endDate = new Date(p.end_date).toLocaleString();
              const badge = p.is_active
                ? '<span class="badge bg-success">Active</span>'
                : '<span class="badge bg-secondary">Inactive</span>';
              const row = document.createElement("tr");
              row.innerHTML = `
                <td>${p.product_name}</td>
                <td>${
                  p.discount_type === "percent"
                    ? p.discount_value + "%"
                    : "$" + p.discount_value
                } off</td>
                <td>${startDate}</td>
                <td>${endDate}</td>
                <td>${badge}</td>
                <td>
                  <button class="btn btn-sm btn-warning me-1" onclick="editPromotion(${
                    p.id
                  })">
                    <i class="bi bi-pencil"></i>
                  </button>
                  <button class="btn btn-sm btn-danger" onclick="deletePromotion(${
                    p.id
                  })">
                    <i class="bi bi-trash"></i>
                  </button>
                </td>
              `;
              table.appendChild(row);
            });
            renderPagination("promotions", "promotions-pagination", page.totalPages, loadPromotions);
          })
          .catch((err) => {
            table.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-danger">Failed to load promotions.</td></tr>`;
            renderPagination("promotions", "promotions-pagination", 1, loadPromotions);
            console.error(err);
          });
      }

      function loadProductsForPromotionModal() {
        return new Promise((resolve, reject) => {
          // USING CACHED PRODUCTS
          loadProductsCached()
            .then((products) => {
              const select = document.getElementById("promotion-product-id");
              select.innerHTML = "";
              products.forEach((p) => {
                const opt = document.createElement("option");
                opt.value = p.id;
                opt.textContent = `${p.name} ($${p.price.toFixed(2)})`;
                select.appendChild(opt);
              });
              resolve();
            })
            .catch((err) => {
              console.error("Error loading products:", err);
              reject(err);
            });
        });
      }

      function loadTopProducts() {
        // USING CACHED PRODUCTS
        loadProductsCached()
          .then((products) => {
            // Sort by stock (for demo - in real app, sort by sales)
            const topProducts = [...products]
              .sort((a, b) => b.stock - a.stock)
              .slice(0, 5);
            const topProductsList =
              document.getElementById("top-products-list");
            topProductsList.innerHTML = "";

            topProducts.forEach((product) => {
              const item = document.createElement("a");
              item.className = "list-group-item list-group-item-action";
              item.innerHTML = `
                                  <div class="d-flex w-100 justify-content-between">
                                      <h6 class="mb-1">${product.name}</h6>
                                      <small>${formatCurrency(product.price)}</small>
                                  </div>
                                  <div class="d-flex w-100 justify-content-between">
                                      <small class="text-muted">Stock: ${
                                        product.stock
                                      }</small>
                                      <small class="${
                                        product.stock < 5
                                          ? "text-danger"
                                          : "text-success"
                                      }">
                                          ${
                                            product.stock < 5
                                              ? "Low Stock"
                                              : "In Stock"
                                          }
                                      </small>
                                  </div>
                              `;
              topProductsList.appendChild(item);
            });

            normalizeCurrencyDisplay(topProductsList);
          })
          .catch((error) => {
            console.error("Error loading top products:", error);
          });
      }

      // POS functions
      function loadProductsForPOS() {
        const productGrid = document.getElementById("product-grid");
        productGrid.innerHTML = `
                      <div class="col-12 text-center py-5">
                          <div class="spinner-border text-primary" role="status">
                              <span class="visually-hidden">Loading...</span>
                          </div>
                      </div>
                  `;

        // USING CACHED PRODUCTS
        loadProductsCached()
          .then((data) => {
            productGrid.innerHTML = "";

            if (data.length === 0) {
              productGrid.innerHTML =
                '<div class="col-12 text-center py-4 text-muted">No products available.</div>';
              return;
            }

            data.forEach((product) => {
              const productCard = document.createElement("div");
              productCard.className = "col-md-4 mb-3";
              productCard.innerHTML = `
          <div class="card product-card" onclick="addToCart(${
            product.id
          }, '${escapeHtml(product.name)}', ${product.price}, 1, ${
                product.tax_rate
              })">
              <div class="card-body p-3">
                  ${getProductPhotoHtml(product.photo_url, product.name, "product-card-img")}
                  <h6 class="card-title fw-bold text-success mb-2">${
                    product.name
                  }</h6>
                  <p class="card-text mb-1">${formatCurrency(product.price)}</p>
                  <small class="text-muted">Stock: ${product.stock}</small>
              </div>
          </div>
      `;

              productGrid.appendChild(productCard);
            });

            normalizeCurrencyDisplay(productGrid);
          })
          .catch((error) => {
            console.error("Error loading products:", error);
            productGrid.innerHTML =
              '<div class="col-12 text-center py-4 text-danger">Failed to load products.</div>';
          });
      }

      function searchProducts() {
        const query = document.getElementById("product-search").value.trim();
        if (!query) {
          loadProductsForPOS();
          return;
        }

        fetch("/api/products/search?q=" + encodeURIComponent(query))
          .then((response) => response.json())
          .then((data) => {
            const productGrid = document.getElementById("product-grid");
            productGrid.innerHTML = "";

            if (data.length === 0) {
              productGrid.innerHTML =
                '<div class="col-12 text-center py-4 text-muted">No products found matching your search.</div>';
              return;
            }

            data.forEach((product) => {
              const productCard = document.createElement("div");
              productCard.className = "col-md-4 mb-3";
              productCard.innerHTML = `
                                  <div class="card product-card" onclick="addToCart(${
                                    product.id
                                  }, '${escapeHtml(product.name)}', ${
                product.price
              }, 1, ${product.tax_rate || 0})">

                                      <div class="card-body">
                                          ${getProductPhotoHtml(product.photo_url, product.name, "product-card-img")}
                                          <h6 class="card-title fw-bold text-success mb-2">${
                                            product.name
                                          }</h6>
                                          <p class="card-text">${formatCurrency(product.price)}</p>
                                          <small class="text-muted">Stock: ${
                                            product.stock
                                          }</small>
                                      </div>
                                  </div>
                              `;
              productGrid.appendChild(productCard);
            });

            normalizeCurrencyDisplay(productGrid);

            document.getElementById("product-search").value = "";
            document.getElementById("product-search").focus();
          })
          .catch((error) => {
            console.error("Error searching products:", error);
            document.getElementById("product-grid").innerHTML =
              '<div class="col-12 text-center py-4 text-danger">Failed to search products.</div>';
          });
      }

      function addToCart(productId, name, price, quantity, tax_rate) {
        // First, fetch the product to check stock AND promotions
        fetch(`/api/products/${productId}`)
          .then((response) => {
            if (!response.ok) {
              throw new Error("Product not found: " + response.status);
            }
            return response.json();
          })
          .then((product) => {
            if (!product) {
              alert("Product not found!");
              return;
            }

            // Check stock
            const maxAvailable = product.stock;
            if (quantity > maxAvailable) {
              const available = confirm(
                `${product.name} has only ${maxAvailable} in stock.\n` +
                  `Would you like to add ${maxAvailable} instead?`
              );
              if (!available) return;
              quantity = maxAvailable;
            }

            // Apply promotions (if any)
            let finalPrice = product.price;
            const now = new Date();

            if (product.promotions && Array.isArray(product.promotions)) {
              const activePromo = product.promotions.find((p) => {
                const start = new Date(p.start_date);
                const end = new Date(p.end_date);
                return now >= start && now <= end;
              });

              if (activePromo) {
                if (activePromo.discount_type === "percent") {
                  const discountAmount =
                    product.price * (activePromo.discount_value / 100);
                  finalPrice = Math.max(0, product.price - discountAmount);
                } else if (activePromo.discount_type === "fixed") {
                  finalPrice = Math.max(
                    0,
                    product.price - activePromo.discount_value
                  );
                }
                showToast(
                  `${product.name} discounted to ${formatCurrency(finalPrice)}!`,
                  "success"
                );
              }
            }

            // Add or update cart
            const existingItem = cart.find(
              (item) => item.product_id === productId
            );
            if (existingItem) {
              const newQty = existingItem.quantity + quantity;
              if (newQty > maxAvailable) {
                alert(
                  `Cannot add more than ${maxAvailable} units of ${product.name}.`
                );
                return;
              }
              existingItem.quantity = newQty;
              existingItem.price = finalPrice;
            } else {
              cart.push({
                product_id: productId,
                name: product.name,
                price: finalPrice,
                quantity: quantity,
                tax_rate: product.tax_rate || 0,
                original_price: product.price,
              });
            }

            updateCartDisplay();
            showToast(`${quantity} Ã— ${product.name} added to cart`, "info");

            // Refocus search
            const searchInput = document.getElementById("product-search");
            searchInput.value = "";
            searchInput.focus();
          })
          .catch((err) => {
            console.error("Error adding to cart:", err);
            alert("Failed to add product. Check connection.");
          });
      }

      function updateCartDisplay() {
        const cartItems = document.getElementById("cart-items");
        if (cart.length === 0) {
          cartItems.innerHTML =
            '<p class="text-muted text-center py-3">No items added</p>';
          document.getElementById("subtotal").textContent = formatCurrency(0);
          document.getElementById("tax").textContent = formatCurrency(0);
          document.getElementById("total").textContent = formatCurrency(0);
          return;
        }
        let subtotalCents = 0;
        let taxCents = 0;
        cartItems.innerHTML = "";
        cart.forEach((item, index) => {
          const priceCents = Math.round(Number(item.price) * 100);
          const itemTotalCents = priceCents * Number(item.quantity);
          const itemTaxCents = Math.round(
            (itemTotalCents * Number(item.tax_rate)) / 100
          );
          subtotalCents += itemTotalCents;
          taxCents += itemTaxCents;
          const itemElement = document.createElement("div");
          itemElement.className =
            "d-flex justify-content-between align-items-center mb-2 border-bottom pb-2";
          const itemTotal = (itemTotalCents / 100).toFixed(2);
          itemElement.innerHTML = `
                  <div>
                      <h6 class="mb-0">${item.name}</h6>
      ${
        item.original_price && item.original_price > item.price
          ? `<small class="text-danger">Was ${formatCurrency(item.original_price)}</small>`
          : ""
      }
                      <small class="text-muted">${formatCurrency(Number(item.price))} x ${item.quantity}</small>
                  </div>
                  <div class="text-end">
                      <h6 class="mb-0">${formatCurrency(itemTotal)}</h6>
                      <div class="btn-group btn-group-sm" role="group">
                          <button class="btn btn-outline-secondary" onclick="adjustQuantity(${index}, -1)">
                              <i class="bi bi-dash"></i>
                          </button>
                          <button class="btn btn-outline-secondary" onclick="adjustQuantity(${index}, 1)">
                              <i class="bi bi-plus"></i>
                          </button>
                          <button class="btn btn-outline-danger" onclick="removeFromCart(${index})">
                              <i class="bi bi-trash"></i>
                          </button>
                      </div>
                  </div>
              `;
          cartItems.appendChild(itemElement);
        });
        const totalCents = subtotalCents + taxCents;
        document.getElementById("subtotal").textContent = formatCurrency(subtotalCents / 100);
        document.getElementById("tax").textContent = formatCurrency(taxCents / 100);
        document.getElementById("total").textContent = formatCurrency(totalCents / 100);
        updateCashRefundDisplay();
      }

      function getCurrentCartTotal() {
        return cart.reduce((sum, item) => {
          const itemTotal = Number(item.price) * Number(item.quantity);
          const itemTax = (itemTotal * Number(item.tax_rate || 0)) / 100;
          return sum + itemTotal + itemTax;
        }, 0);
      }

      function toggleCashPaymentFields() {
        const paymentMethod = document.getElementById("payment-method")?.value;
        const cashSection = document.getElementById("cash-payment-fields");
        if (!cashSection) return;
        cashSection.style.display = paymentMethod === "cash" ? "block" : "none";
      }

      function updateCashRefundDisplay() {
        const refundElement = document.getElementById("refund-amount");
        const paymentMethod = document.getElementById("payment-method")?.value;
        const cashInput = document.getElementById("cash-received");
        if (!refundElement) return;

        if (paymentMethod !== "cash") {
          refundElement.textContent = formatCurrency(0);
          return;
        }

        const total = getCurrentCartTotal();
        const cashReceived = parseFloat(cashInput?.value || "0") || 0;
        const refund = cashReceived - total;
        refundElement.textContent = formatCurrency(Math.max(refund, 0));
        refundElement.className = `fw-bold ${refund < 0 ? "text-danger" : "text-success"}`;
      }

      function adjustQuantity(index, change) {
        cart[index].quantity += change;

        if (cart[index].quantity <= 0) {
          cart.splice(index, 1);
        }

        updateCartDisplay();
      }

      function removeFromCart(index) {
        cart.splice(index, 1);
        updateCartDisplay();
      }

      function clearCart() {
        if (cart.length === 0) return;

        if (confirm("Are you sure you want to clear the cart?")) {
          cart = [];
          updateCartDisplay();
        }
      }

      function completeSale() {
        if (cart.length === 0) {
          alert("Please add items to the cart before completing the sale");
          return;
        }

        const paymentMethod = document.getElementById("payment-method").value;
        const customerId = document.getElementById("pos-customer-select").value;

        // If payment method is debt, ensure a customer is selected
        if (paymentMethod === "debt" && !customerId) {
          alert("Please select a customer for debt transactions");
          return;
        }

        const saleData = {
          items: cart.map((item) => ({
            product_id: item.product_id,
            price: item.price,
            quantity: item.quantity,
            tax_rate: item.tax_rate,
          })),
          payment_method: paymentMethod,
        };

        if (paymentMethod === "cash") {
          const cashReceived = parseFloat(document.getElementById("cash-received").value || "0");
          const total = getCurrentCartTotal();
          if (isNaN(cashReceived) || cashReceived < total) {
            alert("Cash received must be equal to or greater than total amount");
            return;
          }
          saleData.cash_received = Number(cashReceived.toFixed(2));
        }

        // Include customer_id if a customer is selected
        if (customerId) {
          saleData.customer_id = parseInt(customerId);
        }

        fetch("/api/sales", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(saleData),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              const message = paymentMethod === "debt" 
                ? `Sale completed and charged to customer! Transaction ID: ${data.transaction_id}`
                : `Sale completed successfully! Transaction ID: ${data.transaction_id}`;
              
              alert(message);
              cart = [];
              updateCartDisplay();
              document.getElementById("cash-received").value = "";
              updateCashRefundDisplay();
              loadSales();
              loadDashboardStats();
              invalidateProductsCache();
            } else {
              alert("Error completing sale: " + (data.message || "Unknown error"));
            }
          })
          .catch((error) => {
            console.error("Error:", error);
            alert("Error completing sale: " + error.message);
          });
      }

      // Barcode Label functions
      function showBarcodeLabelDialog() {
        const modal = new bootstrap.Modal(
          document.getElementById("barcodeLabelModal")
        );
        loadProductsForBarcodeLabels();
        modal.show();
      }

      function loadProductsForBarcodeLabels() {
        const table = document.getElementById("barcode-products-table");
        table.innerHTML = `
              <tr>
                  <td colspan="5" class="text-center py-4">
                      <div class="spinner-border text-primary" role="status">
                          <span class="visually-hidden">Loading...</span>
                      </div>
                  </td>
              </tr>
          `;

        // USING CACHED PRODUCTS
        loadProductsCached()
          .then((data) => {
            table.innerHTML = "";

            if (data.length === 0) {
              table.innerHTML = `
                          <tr>
                              <td colspan="5" class="text-center py-4 text-muted">No products found.</td>
                          </tr>
                      `;
              return;
            }

            data.forEach((product) => {
              const row = document.createElement("tr");
              row.innerHTML = `
                          <td><input type="checkbox" class="product-checkbox" data-id="${
                            product.id
                          }"></td>
                          <td>${product.barcode || "N/A"}</td>
                          <td>${product.name}</td>
                          <td>$${product.price.toFixed(2)}</td>
                          <td>${product.stock}</td>
                      `;
              table.appendChild(row);
            });
          })
          .catch((error) => {
            console.error("Error loading products:", error);
            table.innerHTML = `
                      <tr>
                          <td colspan="5" class="text-center py-4 text-danger">Failed to load products.</td>
                      </tr>
                  `;
          });
      }

      function toggleSelectAllProducts() {
        const selectAll = document.getElementById(
          "select-all-products"
        ).checked;
        document.querySelectorAll(".product-checkbox").forEach((checkbox) => {
          checkbox.checked = selectAll;
        });
      }

      function generateBarcodeLabels() {
        const selectedProducts = [];
        document
          .querySelectorAll(".product-checkbox:checked")
          .forEach((checkbox) => {
            selectedProducts.push(parseInt(checkbox.getAttribute("data-id")));
          });

        if (selectedProducts.length === 0) {
          alert("Please select at least one product to generate labels");
          return;
        }

        fetch("/api/products/barcode_labels", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            product_ids: selectedProducts,
          }),
        })
          .then((response) => {
            if (response.ok) {
              return response.blob();
            }
            throw new Error("Failed to generate labels");
          })
          .then((blob) => {
            // Create a download link and trigger it
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "barcode_labels.pdf";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            // Close the modal
            const modal = bootstrap.Modal.getInstance(
              document.getElementById("barcodeLabelModal")
            );
            modal.hide();
          })
          .catch((error) => {
            console.error("Error generating labels:", error);
            alert("Error generating labels: " + error.message);
          });
      }

      // Product management functions
      function loadProducts() {
        const productsTable = document.getElementById("products-table");
        productsTable.innerHTML = `
                      <tr>
                          <td colspan="8" class="text-center py-4">
                              <div class="spinner-border text-primary" role="status">
                                  <span class="visually-hidden">Loading...</span>
                              </div>
                          </td>
                      </tr>
                  `;

        // USING CACHED PRODUCTS
        loadProductsCached()
          .then((data) => {
            productsTable.innerHTML = "";
            const query = (document.getElementById("products-search")?.value || "")
              .trim()
              .toLowerCase();
            const filtered = (data || []).filter((product) => {
              if (!query) return true;
              return (
                String(product.barcode || "").toLowerCase().includes(query) ||
                String(product.name || "").toLowerCase().includes(query) ||
                String(product.category || "").toLowerCase().includes(query)
              );
            });

            if (filtered.length === 0) {
              productsTable.innerHTML = `
                                  <tr>
                                      <td colspan="8" class="text-center py-4 text-muted">No products found.</td>
                                  </tr>
                              `;
              renderPagination("products", "products-pagination", 1, loadProducts);
              return;
            }

            const page = paginateArray(filtered, "products");
            page.items.forEach((product) => {
              const row = document.createElement("tr");
              row.innerHTML = `
                                  <td>${getProductPhotoHtml(product.photo_url, product.name, "product-thumb")}</td>
                                  <td>${product.barcode || "N/A"}</td>
                                  <td>${product.name}</td>
                                  <td>$${product.price.toFixed(2)}</td>
                                  <td>${product.stock}</td>
                                  <td>${product.category || "N/A"}</td>
                                  <td>${product.tax_rate}%</td>
                                  <td>
                                      <button class="btn btn-sm btn-primary me-1" onclick="editProduct(${
                                        product.id
                                      })">
                                          <i class="bi bi-pencil"></i>
                                      </button>
                                      <button class="btn btn-sm btn-danger" onclick="deleteProduct(${
                                        product.id
                                      }, '${escapeHtml(product.name)}')">
                                          <i class="bi bi-trash"></i>
                                      </button>
                                  </td>
                              `;
              productsTable.appendChild(row);
            });
            renderPagination("products", "products-pagination", page.totalPages, loadProducts);
          })
          .catch((error) => {
            console.error("Error loading products:", error);
            productsTable.innerHTML = `
                              <tr>
                                  <td colspan="8" class="text-center py-4 text-danger">Failed to load products.</td>
                              </tr>
                          `;
            renderPagination("products", "products-pagination", 1, loadProducts);
          });
      }

      function saveProduct() {
        const barcode = document.getElementById("add-barcode").value.trim();
        const name = document.getElementById("add-product-name").value.trim();
        const price = parseFloat(document.getElementById("add-price").value);
        const cost = parseFloat(document.getElementById("add-cost").value) || 0;
        const stock = parseInt(document.getElementById("add-stock").value);
        const category = document.getElementById("add-category").value.trim();
        const taxRate =
          parseFloat(document.getElementById("add-tax-rate").value) || 0;
        const photoFile = document.getElementById("add-photo").files[0];

        if (!name || isNaN(price) || isNaN(stock)) {
          alert("Please fill in all required fields with valid values");
          return;
        }

        const productData = new FormData();
        productData.append("barcode", barcode || "");
        productData.append("name", name);
        productData.append("price", String(price));
        productData.append("cost", String(cost));
        productData.append("stock", String(stock));
        productData.append("category", category || "");
        productData.append("tax_rate", String(taxRate));
        if (photoFile) {
          productData.append("photo", photoFile);
        }

        fetch("/api/products", {
          method: "POST",
          body: productData,
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              alert("Product added successfully!");
              const modal = bootstrap.Modal.getInstance(
                document.getElementById("addProductModal")
              );
              modal.hide();
              document.getElementById("add-product-form").reset();
              clearImagePreview("add-photo-preview");
              // Invalidate cache since products have changed
              invalidateProductsCache();
              loadProducts();
              loadDashboardStats();
            } else {
              alert(
                "Error adding product: " + (data.message || "Unknown error")
              );
            }
          })
          .catch((error) => {
            console.error("Error saving product:", error);
            alert("Error saving product: " + error.message);
          });
      }

      function editProduct(productId) {
        fetch("/api/products/" + productId)
          .then((response) => response.json())
          .then((product) => {
            currentProduct = product;
            document.getElementById("edit-product-id").value = product.id;
            document.getElementById("edit-barcode").value =
              product.barcode || "";
            document.getElementById("edit-product-name").value = product.name;
            document.getElementById("edit-price").value = product.price;
            document.getElementById("edit-cost").value = product.cost || 0;
            document.getElementById("edit-stock").value = product.stock;
            document.getElementById("edit-category").value =
              product.category || "";
            document.getElementById("edit-tax-rate").value = product.tax_rate;
            document.getElementById("edit-remove-photo").checked = false;
            document.getElementById("edit-photo").value = "";

            const editPreview = document.getElementById("edit-photo-preview");
            const editWrapper = document.getElementById("edit-photo-preview-wrapper");
            if (product.photo_url) {
              editPreview.src = product.photo_url;
              editWrapper.style.display = "block";
            } else {
              clearImagePreview("edit-photo-preview");
            }

            const modal = new bootstrap.Modal(
              document.getElementById("editProductModal")
            );
            modal.show();
          })
          .catch((error) => {
            console.error("Error fetching product:", error);
            alert("Failed to load product for editing");
          });
      }

      function updateProduct() {
        if (!currentProduct) {
          alert("No product selected for update");
          return;
        }

        const productId = document.getElementById("edit-product-id").value;
        const barcode = document.getElementById("edit-barcode").value.trim();
        const name = document.getElementById("edit-product-name").value.trim();
        const price = parseFloat(document.getElementById("edit-price").value);
        const cost =
          parseFloat(document.getElementById("edit-cost").value) || 0;
        const stock = parseInt(document.getElementById("edit-stock").value);
        const category = document.getElementById("edit-category").value.trim();
        const taxRate =
          parseFloat(document.getElementById("edit-tax-rate").value) || 0;
        const photoFile = document.getElementById("edit-photo").files[0];
        const removePhoto = document.getElementById("edit-remove-photo").checked;

        if (!name || isNaN(price) || isNaN(stock)) {
          alert("Please fill in all required fields with valid values");
          return;
        }

        const productData = new FormData();
        productData.append("barcode", barcode || "");
        productData.append("name", name);
        productData.append("price", String(price));
        productData.append("cost", String(cost));
        productData.append("stock", String(stock));
        productData.append("category", category || "");
        productData.append("tax_rate", String(taxRate));
        productData.append("remove_photo", removePhoto ? "true" : "false");
        if (photoFile) {
          productData.append("photo", photoFile);
        }

        fetch("/api/products/" + productId, {
          method: "PUT",
          body: productData,
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              alert("Product updated successfully!");
              const modal = bootstrap.Modal.getInstance(
                document.getElementById("editProductModal")
              );
              modal.hide();
              // Invalidate cache since products have changed
              invalidateProductsCache();
              loadProducts();
              loadDashboardStats();
            } else {
              alert(
                "Error updating product: " + (data.message || "Unknown error")
              );
            }
          })
          .catch((error) => {
            console.error("Error updating product:", error);
            alert("Error updating product: " + error.message);
          });
      }

      function deleteProduct(productId, productName) {
        if (
          !confirm(
            `Are you sure you want to delete "${productName}"? This action cannot be undone.`
          )
        ) {
          return;
        }

        fetch("/api/products/" + productId, {
          method: "DELETE",
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              alert("Product deleted successfully!");
              // Invalidate cache since products have changed
              invalidateProductsCache();
              loadProducts();
              loadDashboardStats();
            } else {
              alert(
                "Error deleting product: " + (data.message || "Unknown error")
              );
            }
          })
          .catch((error) => {
            console.error("Error deleting product:", error);
            alert("Error deleting product: " + error.message);
          });
      }

      // Sales history functions
      function loadSales() {
        const salesTable = document.getElementById("sales-table");
        salesTable.innerHTML = `
                      <tr>
                          <td colspan="7" class="text-center py-4">
                              <div class="spinner-border text-primary" role="status">
                                  <span class="visually-hidden">Loading...</span>
                              </div>
                          </td>
                      </tr>
                  `;

        const dateFilter = document.getElementById("sales-date-filter")?.value;
        const searchQuery = (document.getElementById("sales-search")?.value || "")
          .trim()
          .toLowerCase();

        const params = new URLSearchParams();
        if (dateFilter) {
          params.set("start", dateFilter);
          params.set("end", dateFilter);
        }

        fetch(`/api/reports/sales${params.toString() ? `?${params.toString()}` : ""}`)
          .then((response) => response.json())
          .then((data) => {
            salesTable.innerHTML = "";
            const filtered = (data || []).filter((sale) => {
              if (!searchQuery) return true;
              return (
                String(sale.transaction_id || "").toLowerCase().includes(searchQuery) ||
                String(sale.payment_method || "").toLowerCase().includes(searchQuery) ||
                String(sale.username || "").toLowerCase().includes(searchQuery)
              );
            });

            if (filtered.length === 0) {
              salesTable.innerHTML = `
                                  <tr>
                                      <td colspan="7" class="text-center py-4 text-muted">No sales recorded.</td>
                                  </tr>
                              `;
              renderPagination("sales", "sales-pagination", 1, loadSales);
              return;
            }

            const page = paginateArray(filtered, "sales");
            page.items.forEach((sale) => {
              const row = document.createElement("tr");
              row.innerHTML = `
                                  <td>${sale.transaction_id}</td>
                                  <td>${new Date(
                                    sale.date
                                  ).toLocaleString()}</td>
                                  <td>$${sale.total.toFixed(2)}</td>
                                  <td>$${(sale.refund_amount || 0).toFixed(2)}</td>
                                  <td>${sale.payment_method}</td>
                                  <td>${sale.username || "Unknown"}</td>
                                  <td>
                                      <div class="btn-group btn-group-sm" role="group">
                                        <button class="btn btn-info" onclick="viewSaleDetails('${
                                          sale.transaction_id
                                        }')">
                                            <i class="bi bi-info-circle"></i>
                                        </button>
                                        <button class="btn btn-warning" onclick="openReturnExchangeModal('${
                                          sale.transaction_id
                                        }')">
                                            <i class="bi bi-arrow-left-right"></i>
                                        </button>
                                      </div>
                                  </td>
                              `;
              salesTable.appendChild(row);
            });
            renderPagination("sales", "sales-pagination", page.totalPages, loadSales);
          })
          .catch((error) => {
            console.error("Error loading sales:", error);
            salesTable.innerHTML = `
                              <tr>
                                  <td colspan="7" class="text-center py-4 text-danger">Failed to load sales.</td>
                              </tr>
                          `;
            renderPagination("sales", "sales-pagination", 1, loadSales);
          });
      }

      function filterSalesByDate() {
        pageState.sales = 1;
        loadSales();
      }

      function viewSaleDetails(transactionId) {
        const modal = new bootstrap.Modal(
          document.getElementById("saleDetailsModal")
        );
        document.getElementById("sale-id-display").textContent = transactionId;

        const content = document.getElementById("sale-details-content");
        content.innerHTML = `
                      <div class="text-center py-4">
                          <div class="spinner-border text-primary" role="status">
                              <span class="visually-hidden">Loading...</span>
                          </div>
                      </div>
                  `;

        modal.show();

        fetch("/api/sales/" + transactionId)
          .then((response) => response.json())
          .then((sale) => {
            let itemsHtml = "";
            let subtotal = 0;

            sale.items.forEach((item) => {
              const itemTotal = item.price * item.quantity;
              subtotal += itemTotal;

              itemsHtml += `
                                  <tr>
                                      <td>${item.name}</td>
                                      <td>$${item.price.toFixed(2)}</td>
                                      <td>${item.quantity}</td>
                                      <td>${item.tax_rate}%</td>
                                      <td>$${itemTotal.toFixed(2)}</td>
                                  </tr>
                              `;
            });

            const tax = sale.tax || 0;
            const total = sale.total || subtotal + tax;
            const returnHistoryHtml = (sale.return_exchange_history || []).length
              ? `
                  <h6 class="mt-4">Return / Exchange History</h6>
                  <div class="table-responsive">
                    <table class="table table-sm table-bordered">
                      <thead>
                        <tr>
                          <th>Workflow</th><th>Mode</th><th>Return</th><th>Exchange</th><th>Net</th><th>Date</th>
                        </tr>
                      </thead>
                      <tbody>
                        ${(sale.return_exchange_history || []).map((r) => `
                          <tr>
                            <td>${r.workflow_id}</td>
                            <td>${r.mode}</td>
                            <td>${formatCurrency(r.return_total || 0)}</td>
                            <td>${formatCurrency(r.exchange_total || 0)}</td>
                            <td>${formatCurrency(r.net_total || 0)}</td>
                            <td>${r.created_at ? new Date(r.created_at).toLocaleString() : "-"}</td>
                          </tr>
                        `).join("")}
                      </tbody>
                    </table>
                  </div>
                `
              : "";

            content.innerHTML = `
                              <div class="row mb-4">
                                  <div class="col-md-6">
                                      <h6>Transaction ID</h6>
                                      <p>${sale.transaction_id}</p>
                                  </div>
                                  <div class="col-md-6">
                                      <h6>Date</h6>
                                      <p>${new Date(
                                        sale.date
                                      ).toLocaleString()}</p>
                                  </div>
                              </div>

                              <h5 class="mb-3">Items</h5>
                              <div class="table-responsive">
                                  <table class="table table-striped">
                                      <thead>
                                          <tr>
                                              <th>Product</th>
                                              <th>Price</th>
                                              <th>Qty</th>
                                              <th>Tax</th>
                                              <th>Total</th>
                                          </tr>
                                      </thead>
                                      <tbody>
                                          ${itemsHtml}
                                      </tbody>
                                      <tfoot>
                                          <tr>
                                              <th colspan="4" class="text-end">Subtotal:</th>
                                              <th>$${subtotal.toFixed(2)}</th>
                                          </tr>
                                          <tr>
                                              <th colspan="4" class="text-end">Tax:</th>
                                              <th>$${tax.toFixed(2)}</th>
                                          </tr>
                                          <tr class="table-active">
                                              <th colspan="4" class="text-end">Total:</th>
                                              <th>$${total.toFixed(2)}</th>
                                          </tr>
                                      </tfoot>
                                  </table>
                              </div>

                              <div class="row mt-4">
                                  <div class="col-md-6">
                                      <h6>Payment Method</h6>
                                      <p>${sale.payment_method}</p>
                                  </div>
                                  <div class="col-md-6">
                                      <h6>Processed By</h6>
                                      <p>User ID: ${sale.username}</p>
                                  </div>
                              </div>
                              <div class="row mt-2">
                                  <div class="col-md-6">
                                      <h6>Cash Received</h6>
                                      <p>$${(sale.cash_received || 0).toFixed(2)}</p>
                                  </div>
                                  <div class="col-md-6">
                                      <h6>Refund Given</h6>
                                      <p>$${(sale.refund_amount || 0).toFixed(2)}</p>
                                  </div>
                              </div>
                              ${returnHistoryHtml}
                          `;
          })
          .catch((error) => {
            console.error("Error loading sale details:", error);
            content.innerHTML = `
                              <div class="alert alert-danger">
                                  Failed to load sale details. Please try again.
                              </div>
                          `;
          });
      }

      function printReceipt() {
        const transactionId =
          document.getElementById("sale-id-display").textContent;
        window.open(`/api/sales/${transactionId}/print`, "_blank");
        const modal = bootstrap.Modal.getInstance(
          document.getElementById("saleDetailsModal")
        );
        modal.hide();
      }

      function openReturnExchangeModal(transactionId) {
        const modal = new bootstrap.Modal(document.getElementById("returnExchangeModal"));
        document.getElementById("return-exchange-sale-id").textContent = transactionId;
        document.getElementById("return-items-container").innerHTML = '<div class="text-muted">Loading original sale items...</div>';
        document.getElementById("exchange-items-container").innerHTML = "";
        document.getElementById("return-exchange-notes").value = "";
        document.getElementById("return-exchange-settlement-method").value = "cash";
        returnExchangeSaleData = null;
        modal.show();

        fetch(`/api/sales/${transactionId}`)
          .then((r) => r.json())
          .then((sale) => {
            if (!sale || !sale.transaction_id) {
              throw new Error(sale?.message || "Sale not found");
            }
            returnExchangeSaleData = sale;
            const availableItems = (sale.items || []).filter((i) => (i.available_return_quantity || 0) > 0);
            const container = document.getElementById("return-items-container");
            container.innerHTML = "";
            if (availableItems.length === 0) {
              container.innerHTML = '<div class="alert alert-info mb-0">No returnable quantity left for this sale.</div>';
            } else {
              addReturnItemRow();
            }
            addExchangeItemRow();
            refreshReturnExchangeSummary();
          })
          .catch((e) => {
            document.getElementById("return-items-container").innerHTML = `<div class="alert alert-danger mb-0">${e.message}</div>`;
          });
      }

      function addReturnItemRow() {
        if (!returnExchangeSaleData) return;
        const items = (returnExchangeSaleData.items || []).filter((i) => (i.available_return_quantity || 0) > 0);
        if (!items.length) return;

        const row = document.createElement("div");
        row.className = "row g-2 mb-2 return-item-row";
        row.innerHTML = `
          <div class="col-7"><select class="form-select return-item-select"></select></div>
          <div class="col-3"><input type="number" min="1" value="1" class="form-control return-item-qty" /></div>
          <div class="col-2"><button class="btn btn-outline-danger w-100" onclick="this.closest('.return-item-row').remove(); refreshReturnExchangeSummary();"><i class="bi bi-x"></i></button></div>
        `;
        const select = row.querySelector(".return-item-select");
        select.innerHTML = '<option value="">Select item</option>';
        items.forEach((item) => {
          const opt = document.createElement("option");
          opt.value = item.sale_item_id;
          opt.dataset.maxQty = item.available_return_quantity;
          opt.dataset.price = item.price;
          opt.textContent = `${item.name} | Sold: ${item.quantity} | Returnable: ${item.available_return_quantity} | ${formatCurrency(item.price)}`;
          select.appendChild(opt);
        });

        select.addEventListener("change", () => {
          const max = Number(select.selectedOptions[0]?.dataset.maxQty || 1);
          const qtyInput = row.querySelector(".return-item-qty");
          qtyInput.max = max;
          if (Number(qtyInput.value) > max) qtyInput.value = max;
          refreshReturnExchangeSummary();
        });
        row.querySelector(".return-item-qty").addEventListener("input", () => {
          const max = Number(select.selectedOptions[0]?.dataset.maxQty || 1);
          const input = row.querySelector(".return-item-qty");
          if (Number(input.value) > max) input.value = max;
          if (Number(input.value) < 1 || Number.isNaN(Number(input.value))) input.value = 1;
          refreshReturnExchangeSummary();
        });

        document.getElementById("return-items-container").appendChild(row);
      }

      function addExchangeItemRow() {
        const row = document.createElement("div");
        row.className = "row g-2 mb-2 exchange-item-row";
        row.innerHTML = `
          <div class="col-6"><select class="form-select exchange-item-select"></select></div>
          <div class="col-2"><input type="number" min="1" value="1" class="form-control exchange-item-qty" /></div>
          <div class="col-3"><input type="number" min="0" step="0.01" value="0" class="form-control exchange-item-price" /></div>
          <div class="col-1"><button class="btn btn-outline-danger w-100" onclick="this.closest('.exchange-item-row').remove(); refreshReturnExchangeSummary();"><i class="bi bi-x"></i></button></div>
        `;
        const select = row.querySelector(".exchange-item-select");
        select.innerHTML = '<option value="">Select product</option>';
        loadProductsCached().then((products) => {
          (products || []).forEach((p) => {
            const opt = document.createElement("option");
            opt.value = p.id;
            opt.dataset.price = p.price;
            opt.dataset.stock = p.stock;
            opt.dataset.taxRate = p.tax_rate || 0;
            opt.textContent = `${p.name} | Stock: ${p.stock} | ${formatCurrency(p.price)}`;
            select.appendChild(opt);
          });
        });

        select.addEventListener("change", () => {
          const selected = select.selectedOptions[0];
          const priceInput = row.querySelector(".exchange-item-price");
          if (selected?.dataset?.price) priceInput.value = Number(selected.dataset.price).toFixed(2);
          refreshReturnExchangeSummary();
        });
        row.querySelector(".exchange-item-qty").addEventListener("input", refreshReturnExchangeSummary);
        row.querySelector(".exchange-item-price").addEventListener("input", refreshReturnExchangeSummary);

        document.getElementById("exchange-items-container").appendChild(row);
      }

      function collectReturnExchangePayload() {
        const returnItems = Array.from(document.querySelectorAll(".return-item-row"))
          .map((row) => {
            const saleItemId = parseInt(row.querySelector(".return-item-select").value || "0", 10);
            const quantity = parseInt(row.querySelector(".return-item-qty").value || "0", 10);
            return saleItemId > 0 && quantity > 0 ? { sale_item_id: saleItemId, quantity } : null;
          })
          .filter(Boolean);

        const exchangeItems = Array.from(document.querySelectorAll(".exchange-item-row"))
          .map((row) => {
            const productId = parseInt(row.querySelector(".exchange-item-select").value || "0", 10);
            const quantity = parseInt(row.querySelector(".exchange-item-qty").value || "0", 10);
            const price = parseFloat(row.querySelector(".exchange-item-price").value || "0");
            return productId > 0 && quantity > 0 ? { product_id: productId, quantity, price } : null;
          })
          .filter(Boolean);

        return { returnItems, exchangeItems };
      }

      function refreshReturnExchangeSummary() {
        if (!returnExchangeSaleData) return;
        const { returnItems, exchangeItems } = collectReturnExchangePayload();
        const saleItemMap = new Map((returnExchangeSaleData.items || []).map((x) => [x.sale_item_id, x]));

        let returnTotal = 0;
        returnItems.forEach((r) => {
          const item = saleItemMap.get(r.sale_item_id);
          if (!item) return;
          const base = Number(item.price) * Number(r.quantity);
          const tax = base * (Number(item.tax_rate || 0) / 100);
          returnTotal += base + tax;
        });

        let exchangeTotal = 0;
        exchangeItems.forEach((e) => {
          const selectedOption = Array.from(document.querySelectorAll('.exchange-item-select')).flatMap((sel) => Array.from(sel.selectedOptions)).find((opt) => Number(opt.value) === Number(e.product_id));
          const taxRate = Number(selectedOption?.dataset?.taxRate || 0);
          const base = Number(e.price) * Number(e.quantity);
          const tax = base * (taxRate / 100);
          exchangeTotal += base + tax;
        });

        const net = exchangeTotal - returnTotal;
        document.getElementById("summary-return-total").textContent = formatCurrency(returnTotal);
        document.getElementById("summary-exchange-total").textContent = formatCurrency(exchangeTotal);
        document.getElementById("summary-net-total").textContent = formatCurrency(net);
        document.getElementById("summary-settlement-hint").textContent = net > 0
          ? `(Collect ${formatCurrency(net)})`
          : net < 0
          ? `(Refund ${formatCurrency(Math.abs(net))})`
          : "(No settlement)";
      }

      function submitReturnExchange() {
        if (!returnExchangeSaleData) return;
        const { returnItems, exchangeItems } = collectReturnExchangePayload();
        if (!returnItems.length) {
          alert("Please add at least one return item.");
          return;
        }

        const payload = {
          original_transaction_id: returnExchangeSaleData.transaction_id,
          return_items: returnItems,
          exchange_items: exchangeItems,
          settlement_method: document.getElementById("return-exchange-settlement-method").value,
          notes: document.getElementById("return-exchange-notes").value.trim() || null,
        };

        fetch("/api/returns_exchanges", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        })
          .then((r) => r.json())
          .then((data) => {
            if (!data.success) {
              alert(data.message || "Failed to process return/exchange");
              return;
            }
            alert(`Workflow completed. ID: ${data.workflow_id}`);
            const modal = bootstrap.Modal.getInstance(document.getElementById("returnExchangeModal"));
            modal.hide();
            invalidateProductsCache();
            loadProducts();
            loadProductsForPOS();
            loadSales();
            loadDashboardStats();
          })
          .catch((e) => {
            alert(`Failed to process return/exchange: ${e.message}`);
          });
      }

      // Reports functions
      function initSalesChart() {
        const ctx = document.getElementById("salesChart").getContext("2d");

        if (salesChart) {
          salesChart.destroy();
        }

        // Default to last 7 days
        const startDate =
          document.getElementById("start-date").value ||
          new Date(new Date().setDate(new Date().getDate() - 7))
            .toISOString()
            .split("T")[0];
        const endDate =
          document.getElementById("end-date").value ||
          new Date().toISOString().split("T")[0];

        fetch("/api/reports/sales?start=" + startDate + "&end=" + endDate)
          .then((response) => response.json())
          .then((data) => {
            // Group sales by date
            const salesByDate = {};
            data.forEach((sale) => {
              const date = sale.date.split("T")[0];
              if (!salesByDate[date]) {
                salesByDate[date] = 0;
              }
              salesByDate[date] += sale.total;
            });

            // Prepare chart data
            const labels = Object.keys(salesByDate).sort();
            const chartData = labels.map((date) => salesByDate[date]);

            salesChart = new Chart(ctx, {
              type: "bar",
              data: {
                labels: labels,
                datasets: [
                  {
                    label: "Daily Sales ($)",
                    data: chartData,
                    backgroundColor: "rgba(54, 162, 235, 0.7)",
                    borderColor: "rgba(54, 162, 235, 1)",
                    borderWidth: 1,
                  },
                ],
              },
              options: {
                responsive: true,
                plugins: {
                  legend: {
                    display: false,
                  },
                },
                scales: {
                  y: {
                    beginAtZero: true,
                    title: {
                      display: true,
                      text: "Amount ($)",
                    },
                  },
                  x: {
                    title: {
                      display: true,
                      text: "Date",
                    },
                  },
                },
              },
            });
          })
          .catch((error) => {
            console.error("Error initializing sales chart:", error);
            ctx.font = "16px Arial";
            ctx.fillStyle = "red";
            ctx.textAlign = "center";
            ctx.fillText(
              "Failed to load chart data",
              ctx.canvas.width / 2,
              ctx.canvas.height / 2
            );
          });
      }

      function initPaymentChart() {
        const ctx = document.getElementById("paymentChart").getContext("2d");

        if (paymentChart) {
          paymentChart.destroy();
        }

        // Default to last 7 days
        const startDate =
          document.getElementById("start-date").value ||
          new Date(new Date().setDate(new Date().getDate() - 7))
            .toISOString()
            .split("T")[0];
        const endDate =
          document.getElementById("end-date").value ||
          new Date().toISOString().split("T")[0];

        fetch("/api/reports/sales?start=" + startDate + "&end=" + endDate)
          .then((response) => response.json())
          .then((data) => {
            // Group sales by payment method
            const paymentMethods = {};
            data.forEach((sale) => {
              if (!paymentMethods[sale.payment_method]) {
                paymentMethods[sale.payment_method] = 0;
              }
              paymentMethods[sale.payment_method] += sale.total;
            });

            // Prepare chart data
            const labels = Object.keys(paymentMethods);
            const chartData = labels.map((method) => paymentMethods[method]);
            const backgroundColors = [
              "rgba(255, 99, 132, 0.7)",
              "rgba(54, 162, 235, 0.7)",
              "rgba(255, 206, 86, 0.7)",
              "rgba(75, 192, 192, 0.7)",
            ];

            paymentChart = new Chart(ctx, {
              type: "doughnut",
              data: {
                labels: labels,
                datasets: [
                  {
                    data: chartData,
                    backgroundColor: backgroundColors,
                    borderWidth: 1,
                  },
                ],
              },
              options: {
                responsive: true,
                plugins: {
                  legend: {
                    position: "bottom",
                  },
                },
              },
            });
          })
          .catch((error) => {
            console.error("Error initializing payment chart:", error);
            ctx.font = "16px Arial";
            ctx.fillStyle = "red";
            ctx.textAlign = "center";
            ctx.fillText(
              "Failed to load chart data",
              ctx.canvas.width / 2,
              ctx.canvas.height / 2
            );
          });
      }

      function generateReport() {
        const startDate = document.getElementById("start-date").value;
        const endDate = document.getElementById("end-date").value;

        if (!startDate || !endDate) {
          alert("Please select both start and end dates");
          return;
        }

        const resultsDiv = document.getElementById("report-results");
        resultsDiv.innerHTML = `
                      <div class="text-center py-4">
                          <div class="spinner-border text-primary" role="status">
                              <span class="visually-hidden">Loading...</span>
                          </div>
                      </div>
                  `;

        fetch("/api/reports/sales?start=" + startDate + "&end=" + endDate)
          .then((response) => response.json())
          .then((data) => {
            const totalSales = data.reduce((sum, sale) => sum + sale.total, 0);
            const totalTax = data.reduce((sum, sale) => sum + sale.tax, 0);
            const totalRefunds = data.reduce((sum, sale) => sum + (sale.refund_amount || 0), 0);
            const refundTransactions = data.filter((sale) => (sale.refund_amount || 0) > 0).length;
            const totalTransactions = data.length;

            // Group by payment method
            const paymentMethods = {};
            data.forEach((sale) => {
              if (!paymentMethods[sale.payment_method]) {
                paymentMethods[sale.payment_method] = {
                  count: 0,
                  total: 0,
                };
              }
              paymentMethods[sale.payment_method].count++;
              paymentMethods[sale.payment_method].total += sale.total;
            });

            let paymentMethodsHtml = "";
            for (const [method, stats] of Object.entries(paymentMethods)) {
              const ratio = totalSales > 0 ? (stats.total / totalSales) * 100 : 0;
              paymentMethodsHtml += `
                                  <tr>
                                      <td>${method}</td>
                                      <td>${stats.count}</td>
                                      <td>$${stats.total.toFixed(2)}</td>
                                      <td>${ratio.toFixed(1)}%</td>
                                  </tr>
                              `;
            }

            resultsDiv.innerHTML = `
                              <div class="row mb-4">
                                  <div class="col-md-3">
                                      <div class="card bg-light">
                                          <div class="card-body text-center">
                                              <h5 class="card-title">Total Sales</h5>
                                              <h3>$${totalSales.toFixed(2)}</h3>
                                          </div>
                                      </div>
                                  </div>
                                  <div class="col-md-3">
                                      <div class="card bg-light">
                                          <div class="card-body text-center">
                                              <h5 class="card-title">Total Tax</h5>
                                              <h3>$${totalTax.toFixed(2)}</h3>
                                          </div>
                                      </div>
                                  </div>
                                  <div class="col-md-3">
                                      <div class="card bg-light">
                                          <div class="card-body text-center">
                                              <h5 class="card-title">Refund Given</h5>
                                              <h3>$${totalRefunds.toFixed(2)}</h3>
                                        <small class="text-muted">${refundTransactions} refunded sales</small>
                                          </div>
                                      </div>
                                  </div>
                                  <div class="col-md-3">
                                      <div class="card bg-light">
                                          <div class="card-body text-center">
                                              <h5 class="card-title">Transactions</h5>
                                              <h3>${totalTransactions}</h3>
                                          </div>
                                      </div>
                                  </div>
                              </div>

                              <h5 class="mb-3">Payment Methods</h5>
                              <div class="table-responsive mb-4">
                                  <table class="table table-striped">
                                      <thead>
                                          <tr>
                                              <th>Method</th>
                                              <th>Transactions</th>
                                              <th>Total</th>
                                              <th>Percentage</th>
                                          </tr>
                                      </thead>
                                      <tbody>
                                          ${paymentMethodsHtml}
                                      </tbody>
                                  </table>
                              </div>

                              <h5 class="mb-3">Recent Transactions</h5>
                              <div class="table-responsive">
                                  <table class="table table-striped">
                                      <thead>
                                          <tr>
                                              <th>Transaction ID</th>
                                              <th>Date</th>
                                              <th>Total</th>
                                              <th>Refund</th>
                                              <th>Payment</th>
                                          </tr>
                                      </thead>
                                      <tbody>
                                          ${data
                                            .slice(0, 5)
                                            .map(
                                              (sale) => `
                                              <tr>
                                                  <td>${
                                                    sale.transaction_id
                                                  }</td>
                                                  <td>${new Date(
                                                    sale.date
                                                  ).toLocaleString()}</td>
                                                  <td>$${sale.total.toFixed(
                                                    2
                                                  )}</td>
                                                  <td>$${(sale.refund_amount || 0).toFixed(2)}</td>
                                                  <td>${
                                                    sale.payment_method
                                                  }</td>
                                              </tr>
                                          `
                                            )
                                            .join("")}
                                      </tbody>
                                  </table>
                              </div>
                          `;

            // Refresh charts with new date range
            initSalesChart();
            initPaymentChart();
          })
          .catch((error) => {
            console.error("Error generating report:", error);
            resultsDiv.innerHTML = `
                              <div class="alert alert-danger">
                                  Failed to generate report. Please try again.
                              </div>
                          `;
          });
      }

      // User management functions
      // Update the loadUsers function to properly handle the response
      function loadUsers() {
        const usersTable = document.getElementById("users-table");
        usersTable.innerHTML = `
          <tr>
            <td colspan="4" class="text-center py-4">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
            </td>
          </tr>
        `;

        fetch("/api/users")
          .then((response) => {
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
          })
          .then((data) => {
            usersTable.innerHTML = "";
            const query = (document.getElementById("users-search")?.value || "")
              .trim()
              .toLowerCase();
            const filtered = (data || []).filter((user) => {
              if (!query) return true;
              return (
                String(user.id).toLowerCase().includes(query) ||
                String(user.username || "").toLowerCase().includes(query) ||
                String(user.role || "").toLowerCase().includes(query)
              );
            });

            if (filtered.length === 0) {
              usersTable.innerHTML = `
                <tr>
                  <td colspan="4" class="text-center py-4 text-muted">No users found.</td>
                </tr>
              `;
              renderPagination("users", "users-pagination", 1, loadUsers);
              return;
            }

            const page = paginateArray(filtered, "users");
            page.items.forEach((user) => {
              const row = document.createElement("tr");
              row.innerHTML = `
                <td>${user.id}</td>
                <td>${user.username}</td>
                <td><span class="badge bg-${
                  user.role === "manager" ? "primary" : "secondary"
                }">${user.role}</span></td>
                <td>
                  <button class="btn btn-sm btn-primary me-1" onclick="editUser(${
                    user.id
                  })">
                    <i class="bi bi-pencil"></i>
                  </button>
                  <button class="btn btn-sm btn-danger" onclick="deleteUser(${
                    user.id
                  }, '${escapeHtml(user.username)}')">
                    <i class="bi bi-trash"></i>
                  </button>
                </td>
              `;
              usersTable.appendChild(row);
            });
            renderPagination("users", "users-pagination", page.totalPages, loadUsers);
          })
          .catch((error) => {
            console.error("Error loading users:", error);
            usersTable.innerHTML = `
              <tr>
                <td colspan="4" class="text-center py-4 text-danger">Failed to load users. ${error.message}</td>
              </tr>
            `;
            renderPagination("users", "users-pagination", 1, loadUsers);
          });
      }

      // Update the saveUser function
      function saveUser() {
        const username = document.getElementById("add-username").value.trim();
        const password = document.getElementById("add-password").value;
        const confirmPassword = document.getElementById(
          "add-confirm-password"
        ).value;
        const role = document.getElementById("add-role").value;

        if (!username || !password) {
          alert("Please fill in all required fields");
          return;
        }

        if (password !== confirmPassword) {
          alert("Passwords do not match");
          return;
        }

        const userData = {
          username: username,
          password: password,
          role: role,
        };

        fetch("/api/users", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(userData),
        })
          .then((response) => {
            if (!response.ok) {
              return response.json().then((error) => {
                throw new Error(error.message || "Unknown error");
              });
            }
            return response.json();
          })
          .then((data) => {
            if (data.success) {
              alert("User added successfully!");
              const modal = bootstrap.Modal.getInstance(
                document.getElementById("addUserModal")
              );
              modal.hide();
              document.getElementById("add-user-form").reset();
              loadUsers();
            } else {
              alert("Error adding user: " + (data.message || "Unknown error"));
            }
          })
          .catch((error) => {
            console.error("Error saving user:", error);
            alert("Error saving user: " + error.message);
          });
      }

      function editUser(userId) {
        fetch("/api/users/" + userId)
          .then((response) => response.json())
          .then((user) => {
            document.getElementById("edit-user-id").value = user.id;
            document.getElementById("edit-username").value = user.username;
            document.getElementById("edit-role").value = user.role;

            const modal = new bootstrap.Modal(
              document.getElementById("editUserModal")
            );
            modal.show();
          })
          .catch((error) => {
            console.error("Error fetching user:", error);
            alert("Failed to load user for editing");
          });
      }

      function updateUser() {
        const userId = document.getElementById("edit-user-id").value;
        const username = document.getElementById("edit-username").value.trim();
        const password = document.getElementById("edit-password").value;
        const confirmPassword = document.getElementById(
          "edit-confirm-password"
        ).value;
        const role = document.getElementById("edit-role").value;

        if (!username) {
          alert("Please fill in all required fields");
          return;
        }

        if (password && password !== confirmPassword) {
          alert("Passwords do not match");
          return;
        }

        const userData = {
          username: username,
          role: role,
        };

        // Only include password if it was provided
        if (password) {
          userData.password = password;
        }

        fetch("/api/users/" + userId, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(userData),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              alert("User updated successfully!");
              const modal = bootstrap.Modal.getInstance(
                document.getElementById("editUserModal")
              );
              modal.hide();
              loadUsers();
            } else {
              alert(
                "Error updating user: " + (data.message || "Unknown error")
              );
            }
          })
          .catch((error) => {
            console.error("Error updating user:", error);
            alert("Error updating user: " + error.message);
          });
      }

      function deleteUser(userId, username) {
        if (
          !confirm(
            `Are you sure you want to delete user "${username}"? This action cannot be undone.`
          )
        ) {
          return;
        }

        fetch("/api/users/" + userId, {
          method: "DELETE",
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              alert("User deleted successfully!");
              loadUsers();
            } else {
              alert(
                "Error deleting user: " + (data.message || "Unknown error")
              );
            }
          })
          .catch((error) => {
            console.error("Error deleting user:", error);
            alert("Error deleting user: " + error.message);
          });
      }

      function savePromotion() {
        const productId = document.getElementById("promotion-product-id").value;
        const discountType = document.getElementById(
          "promotion-discount-type"
        ).value;
        const discountValue = parseFloat(
          document.getElementById("promotion-discount-value").value
        );
        const startDate = document.getElementById("promotion-start-date").value;
        const endDate = document.getElementById("promotion-end-date").value;

        if (!productId || isNaN(discountValue) || !startDate || !endDate) {
          alert("Please fill all fields");
          return;
        }

        fetch("/api/promotions", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            product_id: parseInt(productId),
            discount_type: discountType,
            discount_value: discountValue,
            start_date: startDate,
            end_date: endDate,
          }),
        })
          .then((r) => r.json())
          .then((data) => {
            if (data.success) {
              alert("Promotion created!");
              const modal = bootstrap.Modal.getInstance(
                document.getElementById("addPromotionModal")
              );
              modal.hide();
              loadPromotions();
            } else {
              alert("Error: " + data.message);
            }
          });
      }

      function editPromotion(promoId) {
        fetch(`/api/promotions/${promoId}`)
          .then((r) => r.json())
          .then((promo) => {
            // Load products for dropdown
            loadProductsForPromotionModal().then(() => {
              document.getElementById("promotion-product-id").value =
                promo.product_id;
              document.getElementById("promotion-discount-type").value =
                promo.discount_type;
              document.getElementById("promotion-discount-value").value =
                promo.discount_value;

              // Convert dates to local datetime format for input fields
              const startDate = new Date(promo.start_date);
              const endDate = new Date(promo.end_date);

              document.getElementById("promotion-start-date").value = startDate
                .toISOString()
                .slice(0, 16);
              document.getElementById("promotion-end-date").value = endDate
                .toISOString()
                .slice(0, 16);

              const modal = new bootstrap.Modal(
                document.getElementById("addPromotionModal")
              );

              // Update modal title and button
              document.querySelector(
                "#addPromotionModal .modal-title"
              ).textContent = "Edit Promotion";
              const saveBtn = document.querySelector(
                "#addPromotionModal .btn-primary"
              );
              saveBtn.textContent = "Update Promotion";
              saveBtn.onclick = () => updatePromotion(promoId);

              modal.show();
            });
          })
          .catch((err) => {
            console.error("Error loading promotion:", err);
            alert("Failed to load promotion");
          });
      }

      function updatePromotion(promoId) {
        const productId = document.getElementById("promotion-product-id").value;
        const discountType = document.getElementById(
          "promotion-discount-type"
        ).value;
        const discountValue = parseFloat(
          document.getElementById("promotion-discount-value").value
        );
        const startDate = document.getElementById("promotion-start-date").value;
        const endDate = document.getElementById("promotion-end-date").value;

        if (!productId || isNaN(discountValue) || !startDate || !endDate) {
          alert("Please fill all fields");
          return;
        }

        fetch(`/api/promotions/${promoId}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            product_id: parseInt(productId),
            discount_type: discountType,
            discount_value: discountValue,
            start_date: startDate,
            end_date: endDate,
          }),
        })
          .then((r) => r.json())
          .then((data) => {
            if (data.success) {
              showToast("Promotion updated successfully!", "success");
              const modal = bootstrap.Modal.getInstance(
                document.getElementById("addPromotionModal")
              );
              modal.hide();
              loadPromotions();

              // Reset modal for next use
              document.querySelector(
                "#addPromotionModal .modal-title"
              ).textContent = "Create Promotion";
              const saveBtn = document.querySelector(
                "#addPromotionModal .btn-primary"
              );
              saveBtn.textContent = "Save Promotion";
              saveBtn.onclick = savePromotion;
            } else {
              showToast("Error: " + data.message, "danger");
            }
          })
          .catch((err) => {
            console.error("Error updating promotion:", err);
            showToast("Failed to update promotion", "danger");
          });
      }

      // Add this function to show toast notifications
      function showToast(message, type = "info") {
        // Create toast element if it doesn't exist
        let toastContainer = document.getElementById("toast-container");
        if (!toastContainer) {
          toastContainer = document.createElement("div");
          toastContainer.id = "toast-container";
          document.body.appendChild(toastContainer);
        }

        const toast = document.createElement("div");
        toast.className = `alert alert-${type} alert-dismissible fade show`;
        toast.style.minWidth = "300px";
        toast.style.marginBottom = "10px";
        toast.innerHTML = `
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;

        toastContainer.appendChild(toast);

        // Auto remove after 3 seconds
        setTimeout(() => {
          if (toast.parentNode) {
            toast.remove();
          }
        }, 3000);
      }

      function deletePromotion(promoId) {
        if (!confirm("Delete this promotion?")) return;
        fetch(`/api/promotions/${promoId}`, { method: "DELETE" })
          .then((r) => r.json())
          .then((data) => {
            if (data.success) {
              alert("Promotion deleted!");
              loadPromotions();
            } else {
              alert("Error: " + data.message);
            }
          });
      }

      function exportReport() {
        const startDate = document.getElementById("start-date").value;
        const endDate = document.getElementById("end-date").value;

        if (!startDate || !endDate) {
          alert("Please select both start and end dates");
          return;
        }

        window.open(
          `/api/reports/sales/export?start=${startDate}&end=${endDate}`,
          "_blank"
        );
      }

      // Customer management functions
      function loadCustomers() {
        const customersTable = document.getElementById("customers-table");
        customersTable.innerHTML = `
          <tr>
            <td colspan="5" class="text-center py-4">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
            </td>
          </tr>
        `;

        fetch("/api/customers")
          .then((response) => response.json())
          .then((data) => {
            customersTable.innerHTML = "";
            const query = (document.getElementById("customers-search")?.value || "")
              .trim()
              .toLowerCase();
            const filtered = (data || []).filter((customer) => {
              if (!query) return true;
              return (
                String(customer.name || "").toLowerCase().includes(query) ||
                String(customer.phone || "").toLowerCase().includes(query) ||
                String(customer.email || "").toLowerCase().includes(query)
              );
            });

            if (filtered.length === 0) {
              customersTable.innerHTML = `
                <tr>
                  <td colspan="5" class="text-center py-4 text-muted">No customers found.</td>
                </tr>
              `;
              renderPagination("customers", "customers-pagination", 1, loadCustomers);
              return;
            }

            const page = paginateArray(filtered, "customers");
            page.items.forEach((customer) => {
              const row = document.createElement("tr");
              row.innerHTML = `
                <td>${customer.name}</td>
                <td>${customer.phone || "N/A"}</td>
                <td>${customer.email || "N/A"}</td>
                <td>$${customer.total_debt.toFixed(2)}</td>
                <td>
                  <button class="btn btn-sm btn-info me-1" onclick="viewCustomerDetails(${customer.id})">
                    <i class="bi bi-eye"></i>
                  </button>
                  <button class="btn btn-sm btn-primary me-1" onclick="editCustomer(${customer.id})">
                    <i class="bi bi-pencil"></i>
                  </button>
                  <button class="btn btn-sm btn-danger" onclick="deleteCustomer(${customer.id}, '${escapeHtml(customer.name)}')">
                    <i class="bi bi-trash"></i>
                  </button>
                </td>
              `;
              customersTable.appendChild(row);
            });
            renderPagination("customers", "customers-pagination", page.totalPages, loadCustomers);
          })
          .catch((error) => {
            console.error("Error loading customers:", error);
            customersTable.innerHTML = `
              <tr>
                <td colspan="5" class="text-center py-4 text-danger">Failed to load customers.</td>
              </tr>
            `;
            renderPagination("customers", "customers-pagination", 1, loadCustomers);
          });
      }

      function saveCustomer() {
        const name = document.getElementById("add-customer-name").value.trim();
        const phone = document.getElementById("add-customer-phone").value.trim();
        const email = document.getElementById("add-customer-email").value.trim();
        const address = document.getElementById("add-customer-address").value.trim();

        if (!name) {
          alert("Please fill in the customer name");
          return;
        }

        const customerData = {
          name: name,
          phone: phone || null,
          email: email || null,
          address: address || null,
        };

        fetch("/api/customers", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(customerData),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              alert("Customer added successfully!");
              const modal = bootstrap.Modal.getInstance(
                document.getElementById("addCustomerModal")
              );
              modal.hide();
              document.getElementById("add-customer-form").reset();
              loadCustomers();
              loadCustomersForPOS();
              loadCustomersForDebtModal();
            } else {
              alert("Error adding customer: " + (data.message || "Unknown error"));
            }
          })
          .catch((error) => {
            console.error("Error saving customer:", error);
            alert("Error saving customer: " + error.message);
          });
      }

      function editCustomer(customerId) {
        fetch("/api/customers/" + customerId)
          .then((response) => response.json())
          .then((customer) => {
            document.getElementById("edit-customer-id").value = customer.id;
            document.getElementById("edit-customer-name").value = customer.name;
            document.getElementById("edit-customer-phone").value = customer.phone || "";
            document.getElementById("edit-customer-email").value = customer.email || "";
            document.getElementById("edit-customer-address").value = customer.address || "";

            const modal = new bootstrap.Modal(
              document.getElementById("editCustomerModal")
            );
            modal.show();
          })
          .catch((error) => {
            console.error("Error fetching customer:", error);
            alert("Failed to load customer for editing");
          });
      }

      function updateCustomer() {
        const customerId = document.getElementById("edit-customer-id").value;
        const name = document.getElementById("edit-customer-name").value.trim();
        const phone = document.getElementById("edit-customer-phone").value.trim();
        const email = document.getElementById("edit-customer-email").value.trim();
        const address = document.getElementById("edit-customer-address").value.trim();

        if (!name) {
          alert("Please fill in the customer name");
          return;
        }

        const customerData = {
          name: name,
          phone: phone || null,
          email: email || null,
          address: address || null,
        };

        fetch("/api/customers/" + customerId, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(customerData),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              alert("Customer updated successfully!");
              const modal = bootstrap.Modal.getInstance(
                document.getElementById("editCustomerModal")
              );
              modal.hide();
              loadCustomers();
              loadCustomersForPOS();
              loadCustomersForDebtModal();
            } else {
              alert("Error updating customer: " + (data.message || "Unknown error"));
            }
          })
          .catch((error) => {
            console.error("Error updating customer:", error);
            alert("Error updating customer: " + error.message);
          });
      }

      function deleteCustomer(customerId, customerName) {
        if (
          !confirm(
            `Are you sure you want to delete "${customerName}"? This action cannot be undone.`
          )
        ) {
          return;
        }

        fetch("/api/customers/" + customerId, {
          method: "DELETE",
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              alert("Customer deleted successfully!");
              loadCustomers();
              loadCustomersForPOS();
              loadCustomersForDebtModal();
            } else {
              alert("Error deleting customer: " + (data.message || "Unknown error"));
            }
          })
          .catch((error) => {
            console.error("Error deleting customer:", error);
            alert("Error deleting customer: " + error.message);
          });
      }

      function viewCustomerDetails(customerId) {
        const modal = new bootstrap.Modal(
          document.getElementById("customerDetailsModal")
        );

        const content = document.getElementById("customer-details-content");
        content.innerHTML = `
          <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
          </div>
        `;

        modal.show();

        // Load customer details
        fetch("/api/customers/" + customerId)
          .then((response) => response.json())
          .then((customer) => {
            // Load customer debts
            fetch("/api/customers/" + customerId + "/debts")
              .then((response) => response.json())
              .then((debts) => {
                let debtsHtml = "";
                let totalDebt = 0;

                debts.forEach((debt) => {
                  if (debt.type === "debt") {
                    totalDebt += debt.balance;
                    debtsHtml += `
                      <tr>
                        <td>${debt.notes || "N/A"}</td>
                        <td>$${debt.amount.toFixed(2)}</td>
                        <td>$${debt.balance.toFixed(2)}</td>
                        <td>${new Date(debt.date).toLocaleDateString()}</td>
                        <td>
                          <button class="btn btn-sm btn-success" onclick="showMakePaymentModal(${debt.id})">
                            <i class="bi bi-cash"></i> Pay
                          </button>
                        </td>
                      </tr>
                    `;
                  }
                });

                content.innerHTML = `
                  <div class="row mb-4">
                    <div class="col-md-6">
                      <h6>Name</h6>
                      <p>${customer.name}</p>
                    </div>
                    <div class="col-md-6">
                      <h6>Phone</h6>
                      <p>${customer.phone || "N/A"}</p>
                    </div>
                    <div class="col-md-6">
                      <h6>Email</h6>
                      <p>${customer.email || "N/A"}</p>
                    </div>
                    <div class="col-md-6">
                      <h6>Address</h6>
                      <p>${customer.address || "N/A"}</p>
                    </div>
                  </div>

                  <h5 class="mb-3">Debt History</h5>
                  <div class="table-responsive mb-4">
                    <table class="table table-striped">
                      <thead>
                        <tr>
                          <th>Description</th>
                          <th>Amount</th>
                          <th>Balance</th>
                          <th>Date</th>
                          <th>Actions</th>
                        </tr>
                      </thead>
                      <tbody>
                        ${debtsHtml || '<tr><td colspan="5" class="text-center text-muted">No debt records found.</td></tr>'}
                      </tbody>
                      <tfoot>
                        <tr class="table-active">
                          <th colspan="2" class="text-end">Total Debt:</th>
                          <th>$${totalDebt.toFixed(2)}</th>
                          <th colspan="2"></th>
                        </tr>
                      </tfoot>
                    </table>
                  </div>
                `;
              })
              .catch((error) => {
                console.error("Error loading customer debts:", error);
                content.innerHTML = `
                  <div class="alert alert-danger">
                    Failed to load customer details. Please try again.
                  </div>
                `;
              });
          })
          .catch((error) => {
            console.error("Error loading customer details:", error);
            content.innerHTML = `
              <div class="alert alert-danger">
                Failed to load customer details. Please try again.
              </div>
            `;
          });
      }

      // Debt management functions
      function loadDebts() {
        const debtsTable = document.getElementById("debts-table");
        debtsTable.innerHTML = `
          <tr>
            <td colspan="6" class="text-center py-4">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
            </td>
          </tr>
        `;

        const queryParams = new URLSearchParams();
        const q = (document.getElementById("debts-search")?.value || "").trim();
        const type = (document.getElementById("debts-type-filter")?.value || "").trim();
        const status = (document.getElementById("debts-status-filter")?.value || "").trim();
        if (q) queryParams.set("q", q);
        if (type) queryParams.set("type", type);
        if (status) queryParams.set("status", status);

        fetch(`/api/debts${queryParams.toString() ? `?${queryParams.toString()}` : ""}`)
          .then((response) => response.json())
          .then((data) => {
            debtsTable.innerHTML = "";

            if (data.length === 0) {
              debtsTable.innerHTML = `
                <tr>
                  <td colspan="6" class="text-center py-4 text-muted">No debt records found.</td>
                </tr>
              `;
              renderPagination("debts", "debts-pagination", 1, loadDebts);
              return;
            }

            const page = paginateArray(data, "debts");
            page.items.forEach((debt) => {
              const row = document.createElement("tr");
              const typeBadge = debt.type === "debt" 
                ? '<span class="badge bg-danger">Debt</span>' 
                : '<span class="badge bg-success">Payment</span>';
              
              row.innerHTML = `
                <td>${debt.customer_name}</td>
                <td>$${debt.amount.toFixed(2)}</td>
                <td>$${debt.balance.toFixed(2)}</td>
                <td>${typeBadge}</td>
                <td>${new Date(debt.date).toLocaleDateString()}</td>
                <td>
                  ${debt.type === "debt" ? `
                    <button class="btn btn-sm btn-success me-1" onclick="showMakePaymentModal(${debt.id})">
                      <i class="bi bi-cash"></i> Pay
                    </button>
                  ` : ""}
                  <button class="btn btn-sm btn-info me-1" onclick="viewDebtDetails(${debt.id})">
                    <i class="bi bi-eye"></i>
                  </button>
                  <button class="btn btn-sm btn-danger" onclick="deleteDebt(${debt.id})">
                    <i class="bi bi-trash"></i>
                  </button>
                </td>
              `;
              debtsTable.appendChild(row);
            });
            renderPagination("debts", "debts-pagination", page.totalPages, loadDebts);
          })
          .catch((error) => {
            console.error("Error loading debts:", error);
            debtsTable.innerHTML = `
              <tr>
                <td colspan="6" class="text-center py-4 text-danger">Failed to load debts.</td>
              </tr>
            `;
            renderPagination("debts", "debts-pagination", 1, loadDebts);
          });
      }

      function saveDebt() {
        const customerId = document.getElementById("debt-customer-id").value;
        const amount = parseFloat(document.getElementById("debt-amount").value);
        const notes = document.getElementById("debt-notes").value.trim();

        if (!customerId || isNaN(amount) || amount <= 0) {
          alert("Please fill in all required fields with valid values");
          return;
        }

        const debtData = {
          customer_id: parseInt(customerId),
          amount: amount,
          notes: notes || null,
        };

        fetch("/api/debts", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(debtData),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              alert("Debt record added successfully!");
              const modal = bootstrap.Modal.getInstance(
                document.getElementById("addDebtModal")
              );
              modal.hide();
              document.getElementById("add-debt-form").reset();
              loadDebts();
              loadCustomers();
            } else {
              alert("Error adding debt record: " + (data.message || "Unknown error"));
            }
          })
          .catch((error) => {
            console.error("Error saving debt:", error);
            alert("Error saving debt: " + error.message);
          });
      }

      function deleteDebt(debtId) {
        if (!confirm("Are you sure you want to delete this debt record?")) {
          return;
        }

        fetch("/api/debts/" + debtId, {
          method: "DELETE",
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              alert("Debt record deleted successfully!");
              loadDebts();
              loadCustomers();
            } else {
              alert("Error deleting debt record: " + (data.message || "Unknown error"));
            }
          })
          .catch((error) => {
            console.error("Error deleting debt:", error);
            alert("Error deleting debt: " + error.message);
          });
      }

      function showMakePaymentModal(debtId) {
        fetch("/api/debts/" + debtId)
          .then((response) => response.json())
          .then((debt) => {
            document.getElementById("payment-debt-id").value = debt.id;
            document.getElementById("payment-customer-name").value = debt.customer_name;
            document.getElementById("payment-original-amount").value = debt.amount.toFixed(2);
            document.getElementById("payment-balance").value = debt.balance.toFixed(2);
            document.getElementById("payment-amount").value = debt.balance.toFixed(2);
            document.getElementById("payment-notes").value = "";

            const modal = new bootstrap.Modal(
              document.getElementById("makePaymentModal")
            );
            modal.show();
          })
          .catch((error) => {
            console.error("Error loading debt details:", error);
            alert("Failed to load debt details");
          });
      }

      function makePayment() {
        const debtId = document.getElementById("payment-debt-id").value;
        const amount = parseFloat(document.getElementById("payment-amount").value);
        const notes = document.getElementById("payment-notes").value.trim();

        if (!debtId || isNaN(amount) || amount <= 0) {
          alert("Please enter a valid payment amount");
          return;
        }

        const paymentData = {
          amount: amount,
          notes: notes || null,
        };

        fetch("/api/debts/" + debtId + "/payment", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(paymentData),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              alert("Payment recorded successfully!");
              const modal = bootstrap.Modal.getInstance(
                document.getElementById("makePaymentModal")
              );
              modal.hide();
              loadDebts();
              loadCustomers();
            } else {
              alert("Error recording payment: " + (data.message || "Unknown error"));
            }
          })
          .catch((error) => {
            console.error("Error making payment:", error);
            alert("Error making payment: " + error.message);
          });
      }

      // POS functions for customer selection
      function loadCustomersForPOS() {
        const select = document.getElementById("pos-customer-select");
        select.innerHTML = '<option value="">Walk-in Customer</option>';

        fetch("/api/customers")
          .then((response) => response.json())
          .then((data) => {
            data.forEach((customer) => {
              const option = document.createElement("option");
              option.value = customer.id;
              option.textContent = `${customer.name} (${customer.phone || "No Phone"})`;
              select.appendChild(option);
            });
          })
          .catch((error) => {
            console.error("Error loading customers for POS:", error);
          });
      }

      function loadCustomersForDebtModal() {
        const select = document.getElementById("debt-customer-id");
        select.innerHTML = '<option value="">Select a customer</option>';

        fetch("/api/customers")
          .then((response) => response.json())
          .then((data) => {
            data.forEach((customer) => {
              const option = document.createElement("option");
              option.value = customer.id;
              option.textContent = `${customer.name} (${customer.phone || "No Phone"})`;
              select.appendChild(option);
            });
          })
          .catch((error) => {
            console.error("Error loading customers for debt modal:", error);
          });
      }

      function showCustomerDetails() {
        const customerId = document.getElementById("pos-customer-select").value;
        if (!customerId) {
          alert("Please select a customer first");
          return;
        }
        viewCustomerDetails(parseInt(customerId));
      }

      function viewDebtDetails(debtId) {
        // This function could be implemented to show detailed debt information
        // For now, we'll just show the payment modal
        showMakePaymentModal(debtId);
      }

      // Supplier management functions
      function loadSuppliers() {
        const suppliersTable = document.getElementById("suppliers-table");
        const searchInput = document.getElementById("supplier-search");
        const statusFilter = document.getElementById("supplier-status-filter");

        const searchQuery = searchInput ? searchInput.value.trim() : "";
        const activeFilter = statusFilter ? statusFilter.value : "";
        const queryParams = new URLSearchParams();
        if (searchQuery) queryParams.set("q", searchQuery);
        if (activeFilter) queryParams.set("active", activeFilter);
        const endpoint = `/api/suppliers${queryParams.toString() ? `?${queryParams.toString()}` : ""}`;

        suppliersTable.innerHTML = `
          <tr>
            <td colspan="8" class="text-center py-4">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
            </td>
          </tr>
        `;

        fetch(endpoint)
          .then((response) => response.json())
          .then((data) => {
            suppliersTable.innerHTML = "";
            updateSupplierSummaryCards(Array.isArray(data) ? data : []);

            if (!Array.isArray(data) || data.length === 0) {
              suppliersTable.innerHTML = `
                <tr>
                  <td colspan="8" class="text-center py-4 text-muted">No suppliers found.</td>
                </tr>
              `;
              renderPagination("suppliers", "suppliers-pagination", 1, loadSuppliers);
              return;
            }

            const page = paginateArray(data, "suppliers");
            page.items.forEach((supplier) => {
              const statusBadge = supplier.is_active
                ? '<span class="badge bg-success">Active</span>'
                : '<span class="badge bg-secondary">Inactive</span>';
              const row = document.createElement("tr");
              row.innerHTML = `
                <td>${supplier.name}</td>
                <td>${supplier.contact_person || "N/A"}</td>
                <td>${supplier.phone || "N/A"}</td>
                <td>${supplier.email || "N/A"}</td>
                <td>${supplier.payment_terms || "N/A"}</td>
                <td>${supplier.lead_time_days != null ? `${supplier.lead_time_days} days` : "N/A"}</td>
                <td>${statusBadge}</td>
                <td>
                  <button class="btn btn-sm btn-primary me-1" onclick="editSupplier(${supplier.id})">
                    <i class="bi bi-pencil"></i>
                  </button>
                  <button class="btn btn-sm btn-danger" onclick="deleteSupplier(${supplier.id}, '${escapeHtml(supplier.name)}')">
                    <i class="bi bi-trash"></i>
                  </button>
                </td>
              `;
              suppliersTable.appendChild(row);
            });
            renderPagination("suppliers", "suppliers-pagination", page.totalPages, loadSuppliers);
          })
          .catch((error) => {
            console.error("Error loading suppliers:", error);
            suppliersTable.innerHTML = `
              <tr>
                <td colspan="8" class="text-center py-4 text-danger">Failed to load suppliers.</td>
              </tr>
            `;
            renderPagination("suppliers", "suppliers-pagination", 1, loadSuppliers);
          });
      }

      function updateSupplierSummaryCards(suppliers) {
        const total = suppliers.length;
        const active = suppliers.filter((s) => s.is_active).length;
        const inactive = total - active;
        const leadTimes = suppliers
          .map((s) => s.lead_time_days)
          .filter((value) => Number.isFinite(Number(value)));
        const avgLeadTime = leadTimes.length
          ? Math.round(leadTimes.reduce((sum, value) => sum + Number(value), 0) / leadTimes.length)
          : 0;

        document.getElementById("supplier-total-count").textContent = total;
        document.getElementById("supplier-active-count").textContent = active;
        document.getElementById("supplier-inactive-count").textContent = inactive;
        document.getElementById("supplier-avg-lead-time").textContent = `${avgLeadTime} days`;
      }

      function clearSupplierFilters() {
        const searchInput = document.getElementById("supplier-search");
        const statusFilter = document.getElementById("supplier-status-filter");
        if (searchInput) searchInput.value = "";
        if (statusFilter) statusFilter.value = "";
        pageState.suppliers = 1;
        loadSuppliers();
      }

      function collectSupplierPayload(prefix) {
        const leadTimeRaw = document.getElementById(`${prefix}-supplier-lead-time`).value.trim();
        const leadTime = leadTimeRaw === "" ? null : parseInt(leadTimeRaw, 10);

        return {
          name: document.getElementById(`${prefix}-supplier-name`).value.trim(),
          contact_person: document.getElementById(`${prefix}-supplier-contact`).value.trim() || null,
          phone: document.getElementById(`${prefix}-supplier-phone`).value.trim() || null,
          email: document.getElementById(`${prefix}-supplier-email`).value.trim() || null,
          address: document.getElementById(`${prefix}-supplier-address`).value.trim() || null,
          payment_terms: document.getElementById(`${prefix}-supplier-payment-terms`).value.trim() || null,
          lead_time_days: Number.isNaN(leadTime) ? null : leadTime,
          notes: document.getElementById(`${prefix}-supplier-notes`).value.trim() || null,
          is_active: document.getElementById(`${prefix}-supplier-is-active`).checked,
        };
      }

      function saveSupplier() {
        const payload = collectSupplierPayload("add");

        if (!payload.name) {
          alert("Supplier name is required");
          return;
        }

        if (payload.lead_time_days !== null && payload.lead_time_days < 0) {
          alert("Lead time cannot be negative");
          return;
        }

        fetch("/api/suppliers", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              alert("Supplier added successfully!");
              const modal = bootstrap.Modal.getInstance(document.getElementById("addSupplierModal"));
              modal.hide();
              document.getElementById("add-supplier-form").reset();
              loadSuppliers();
            } else {
              alert("Error adding supplier: " + (data.message || "Unknown error"));
            }
          })
          .catch((error) => {
            console.error("Error saving supplier:", error);
            alert("Error saving supplier: " + error.message);
          });
      }

      function editSupplier(supplierId) {
        fetch(`/api/suppliers/${supplierId}`)
          .then((response) => response.json())
          .then((supplier) => {
            currentSupplier = supplier;
            document.getElementById("edit-supplier-id").value = supplier.id;
            document.getElementById("edit-supplier-name").value = supplier.name || "";
            document.getElementById("edit-supplier-contact").value = supplier.contact_person || "";
            document.getElementById("edit-supplier-phone").value = supplier.phone || "";
            document.getElementById("edit-supplier-email").value = supplier.email || "";
            document.getElementById("edit-supplier-address").value = supplier.address || "";
            document.getElementById("edit-supplier-payment-terms").value = supplier.payment_terms || "";
            document.getElementById("edit-supplier-lead-time").value = supplier.lead_time_days ?? "";
            document.getElementById("edit-supplier-notes").value = supplier.notes || "";
            document.getElementById("edit-supplier-is-active").checked = Boolean(supplier.is_active);

            const modal = new bootstrap.Modal(document.getElementById("editSupplierModal"));
            modal.show();
          })
          .catch((error) => {
            console.error("Error loading supplier:", error);
            alert("Failed to load supplier");
          });
      }

      function updateSupplier() {
        if (!currentSupplier) {
          alert("No supplier selected");
          return;
        }

        const supplierId = document.getElementById("edit-supplier-id").value;
        const payload = collectSupplierPayload("edit");

        if (!payload.name) {
          alert("Supplier name is required");
          return;
        }

        if (payload.lead_time_days !== null && payload.lead_time_days < 0) {
          alert("Lead time cannot be negative");
          return;
        }

        fetch(`/api/suppliers/${supplierId}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              alert("Supplier updated successfully!");
              const modal = bootstrap.Modal.getInstance(document.getElementById("editSupplierModal"));
              modal.hide();
              loadSuppliers();
            } else {
              alert("Error updating supplier: " + (data.message || "Unknown error"));
            }
          })
          .catch((error) => {
            console.error("Error updating supplier:", error);
            alert("Error updating supplier: " + error.message);
          });
      }

      function deleteSupplier(supplierId, supplierName) {
        if (!confirm(`Are you sure you want to delete "${supplierName}"?`)) {
          return;
        }

        fetch(`/api/suppliers/${supplierId}`, { method: "DELETE" })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              alert("Supplier deleted successfully!");
              loadSuppliers();
            } else {
              alert("Error deleting supplier: " + (data.message || "Unknown error"));
            }
          })
          .catch((error) => {
            console.error("Error deleting supplier:", error);
            alert("Error deleting supplier: " + error.message);
          });
      }

      // Purchase workflow functions
      let cachedSuppliersForPO = [];
      let selectedReceivePO = null;

      function loadPurchaseOrders() {
        const table = document.getElementById("purchase-orders-table");
        table.innerHTML = `
          <tr>
            <td colspan="6" class="text-center py-4">
              <div class="spinner-border text-primary" role="status"></div>
            </td>
          </tr>
        `;

        fetch("/api/purchase_orders")
          .then((r) => r.json())
          .then((data) => {
            table.innerHTML = "";
            const query = (document.getElementById("purchase-orders-search")?.value || "")
              .trim()
              .toLowerCase();

            const filtered = (data || []).filter((po) => {
              if (!query) return true;
              return (
                String(po.po_number || "").toLowerCase().includes(query) ||
                String(po.supplier_name || "").toLowerCase().includes(query) ||
                String(po.status || "").toLowerCase().includes(query)
              );
            });

            if (filtered.length === 0) {
              table.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-muted">No purchase orders found.</td></tr>';
              renderPagination("purchases", "purchase-orders-pagination", 1, loadPurchaseOrders);
              return;
            }

            const page = paginateArray(filtered, "purchases");
            page.items.forEach((po) => {
              const badgeClass = po.status === "received" ? "success" : po.status === "partial" ? "warning" : "secondary";
              const row = document.createElement("tr");
              row.innerHTML = `
                <td>${po.po_number}</td>
                <td>${po.supplier_name}</td>
                <td><span class="badge bg-${badgeClass}">${po.status}</span></td>
                <td>${new Date(po.created_at).toLocaleString()}</td>
                <td>${po.received_items_count}/${po.items_count}</td>
                <td>
                  <button class="btn btn-sm btn-success" onclick="openReceivePurchaseOrder(${po.id})" ${po.status === "received" ? "disabled" : ""}>
                    <i class="bi bi-box-arrow-in-down"></i> Receive
                  </button>
                </td>
              `;
              table.appendChild(row);
            });

            renderPagination("purchases", "purchase-orders-pagination", page.totalPages, loadPurchaseOrders);
          })
          .catch((err) => {
            console.error("Error loading purchase orders:", err);
            table.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-danger">Failed to load purchase orders.</td></tr>';
          });
      }

      function preparePurchaseOrderModal() {
        document.getElementById("po-supplier-id").innerHTML = '<option value="">Select supplier</option>';
        document.getElementById("po-notes").value = "";
        document.getElementById("po-items-container").innerHTML = "";

        fetch("/api/suppliers")
          .then((r) => r.json())
          .then((suppliers) => {
            cachedSuppliersForPO = suppliers || [];
            const select = document.getElementById("po-supplier-id");
            cachedSuppliersForPO.forEach((s) => {
              const opt = document.createElement("option");
              opt.value = s.id;
              opt.textContent = s.name;
              select.appendChild(opt);
            });
          })
          .catch((err) => console.error("Error loading suppliers for PO:", err));

        addPurchaseOrderItemRow();
      }

      function addPurchaseOrderItemRow() {
        const container = document.getElementById("po-items-container");
        const row = document.createElement("div");
        row.className = "row g-2 mb-2 po-item-row";
        row.innerHTML = `
          <div class="col-md-5">
            <select class="form-select po-item-product"></select>
          </div>
          <div class="col-md-3">
            <input type="number" min="1" class="form-control po-item-qty" placeholder="Qty" />
          </div>
          <div class="col-md-3">
            <input type="number" min="0" step="0.01" class="form-control po-item-cost" placeholder="Unit Cost" />
          </div>
          <div class="col-md-1">
            <button class="btn btn-outline-danger w-100" onclick="removePurchaseOrderItemRow(this)"><i class="bi bi-x"></i></button>
          </div>
        `;
        container.appendChild(row);

        const productSelect = row.querySelector(".po-item-product");
        productSelect.innerHTML = '<option value="">Select product</option>';
        loadProductsCached().then((products) => {
          products.forEach((p) => {
            const opt = document.createElement("option");
            opt.value = p.id;
            opt.textContent = `${p.name} (${formatCurrency(p.price)})`;
            productSelect.appendChild(opt);
          });
        });
      }

      function removePurchaseOrderItemRow(button) {
        const rows = document.querySelectorAll(".po-item-row");
        if (rows.length <= 1) {
          alert("At least one item is required.");
          return;
        }
        button.closest(".po-item-row").remove();
      }

      function savePurchaseOrder() {
        const supplierId = parseInt(document.getElementById("po-supplier-id").value || "0", 10);
        const notes = document.getElementById("po-notes").value.trim();
        if (!supplierId) {
          alert("Please select supplier.");
          return;
        }

        const itemRows = Array.from(document.querySelectorAll(".po-item-row"));
        const items = [];
        for (const row of itemRows) {
          const productId = parseInt(row.querySelector(".po-item-product").value || "0", 10);
          const orderedQty = parseInt(row.querySelector(".po-item-qty").value || "0", 10);
          const unitCost = parseFloat(row.querySelector(".po-item-cost").value || "0");
          if (!productId || orderedQty <= 0) {
            alert("Each item must have product and quantity > 0");
            return;
          }
          items.push({ product_id: productId, ordered_qty: orderedQty, unit_cost: Number.isFinite(unitCost) ? unitCost : 0 });
        }

        fetch("/api/purchase_orders", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ supplier_id: supplierId, notes, items }),
        })
          .then((r) => r.json())
          .then((data) => {
            if (!data.success) {
              alert(data.message || "Failed to create purchase order");
              return;
            }
            alert("Purchase order created successfully");
            const modal = bootstrap.Modal.getInstance(document.getElementById("addPurchaseOrderModal"));
            modal.hide();
            loadPurchaseOrders();
          })
          .catch((err) => {
            console.error("Error creating PO:", err);
            alert("Failed to create purchase order");
          });
      }

      function openReceivePurchaseOrder(poId) {
        fetch(`/api/purchase_orders/${poId}`)
          .then((r) => r.json())
          .then((po) => {
            if (!po.id) {
              alert(po.message || "Purchase order not found");
              return;
            }

            selectedReceivePO = po;
            document.getElementById("receive-po-number").textContent = po.po_number;
            const container = document.getElementById("receive-po-items-container");
            container.innerHTML = "";

            po.items.forEach((item) => {
              const remaining = item.ordered_qty - item.received_qty;
              const row = document.createElement("div");
              row.className = "row g-2 mb-2 align-items-center";
              row.innerHTML = `
                <div class="col-md-5"><strong>${item.product_name}</strong></div>
                <div class="col-md-3"><small>Remaining: ${remaining}</small></div>
                <div class="col-md-4">
                  <input type="number" min="0" max="${remaining}" value="0" class="form-control receive-item-qty" data-po-item-id="${item.id}" />
                </div>
              `;
              container.appendChild(row);
            });

            const modal = new bootstrap.Modal(document.getElementById("receivePurchaseOrderModal"));
            modal.show();
          })
          .catch((err) => {
            console.error("Error loading PO details:", err);
            alert("Failed to load purchase order details");
          });
      }

      function submitPurchaseReceiving() {
        if (!selectedReceivePO) return;
        const items = Array.from(document.querySelectorAll(".receive-item-qty"))
          .map((input) => ({
            purchase_order_item_id: parseInt(input.dataset.poItemId, 10),
            received_qty: parseInt(input.value || "0", 10),
          }))
          .filter((x) => x.received_qty > 0);

        if (items.length === 0) {
          alert("Enter at least one receiving quantity.");
          return;
        }

        fetch(`/api/purchase_orders/${selectedReceivePO.id}/receive`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ items }),
        })
          .then((r) => r.json())
          .then((data) => {
            if (!data.success) {
              alert(data.message || "Failed to receive items");
              return;
            }
            alert("Stock received successfully");
            const modal = bootstrap.Modal.getInstance(document.getElementById("receivePurchaseOrderModal"));
            modal.hide();
            selectedReceivePO = null;
            invalidateProductsCache();
            loadProducts();
            loadProductsForPOS();
            loadPurchaseOrders();
            loadDashboardStats();
          })
          .catch((err) => {
            console.error("Error receiving PO:", err);
            alert("Failed to receive items");
          });
      }

      // Utility functions
      function getProductPhotoHtml(photoUrl, productName, className = "product-thumb") {
        if (photoUrl) {
          return `<img src="${photoUrl}" alt="${escapeHtml(productName || "Product")}" class="${className}" />`;
        }
        return `<div class="${className} d-flex align-items-center justify-content-center text-muted"><i class="bi bi-image"></i></div>`;
      }

      function previewSelectedProductPhoto(inputId, previewId) {
        const input = document.getElementById(inputId);
        const preview = document.getElementById(previewId);
        const wrapper = document.getElementById(`${previewId}-wrapper`);

        if (!input || !preview || !wrapper) return;

        const file = input.files && input.files[0];
        if (!file) {
          clearImagePreview(previewId);
          return;
        }

        const objectUrl = URL.createObjectURL(file);
        preview.src = objectUrl;
        preview.onload = () => URL.revokeObjectURL(objectUrl);
        wrapper.style.display = "block";
      }

      function clearImagePreview(previewId) {
        const preview = document.getElementById(previewId);
        const wrapper = document.getElementById(`${previewId}-wrapper`);
        if (preview) preview.src = "";
        if (wrapper) wrapper.style.display = "none";
      }

      function escapeHtml(unsafe) {
        return String(unsafe || "")
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }
    </script>
  </body>
</html>
